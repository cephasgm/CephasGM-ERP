<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Payroll Management - CephasGM ERP">
    <title>Payroll Management - CephasGM ERP</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding: 0 1rem;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }

        .main-content {
            grid-column: 2;
            padding: 2rem;
            margin-left: 280px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Enhanced Toolbar */
        .toolbar {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 1.5rem;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--error);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .stat-trend {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--error);
        }

        /* Payroll Overview */
        .payroll-overview {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .overview-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chart-container {
            height: 300px;
            background: var(--background);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Enhanced Tables */
        .table-section {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: var(--surface);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 12px;
            text-align: left;
            font-size: 0.875rem;
        }

        th {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 5;
            font-weight: 600;
        }

        tr:nth-child(even) { 
            background: #f8fafc; 
        }

        tr:hover { 
            background: #f1f5f9; 
        }

        tr.locked {
            background: #fef3c7;
            color: #92400e;
        }

        .currency-select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--surface);
            color: var(--text);
        }

        .amount-cell {
            font-weight: 600;
            text-align: right;
        }

        .positive-amount {
            color: var(--success);
        }

        .negative-amount {
            color: var(--error);
        }

        .actions {
            display: flex;
            gap: 0.25rem;
        }

        .actions button {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Enhanced Modal */
        #payrollModal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-header button:hover {
            color: var(--error);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-grid label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            display: block;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 0.95rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* File Upload Styles */
        .file-upload-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .file-upload-group input[type="file"] {
            flex: 1;
            padding: 0.5rem;
            border: 1px dashed var(--border);
            border-radius: 6px;
        }

        /* Offline Status */
        .offline-status {
            background: var(--warning);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
        }

        /* Section Headers */
        .section-header {
            color: var(--primary);
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: var(--text-light);
            border-top: 1px solid var(--border);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                grid-column: 1;
            }
            .payroll-overview {
                grid-template-columns: 1fr;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .toolbar {
                flex-direction: column;
            }
            .table-container {
                font-size: 0.75rem;
            }
            th, td {
                padding: 8px 4px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0f172a;
                --surface: #1e293b;
                --text: #f1f5f9;
                --text-light: #94a3b8;
                --border: #334155;
            }
            tr:nth-child(even) { 
                background: #1e293b; 
            }
            tr:hover { 
                background: #334155; 
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">CG</div>
                <div>
                    <div style="font-weight: 700; font-size: 1.25rem;">CephasGM</div>
                    <div style="font-size: 0.875rem; color: var(--text-light);">ERP System</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Payroll & HR</div>
                <a href="payroll.html" class="nav-item active">
                    <span class="nav-icon">💳</span>
                    Payroll Management
                </a>
                <a href="hr.html" class="nav-item">
                    <span class="nav-icon">👥</span>
                    HR Management
                </a>
                <a href="attendance.html" class="nav-item">
                    <span class="nav-icon">⏱️</span>
                    Attendance
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">Payroll Modules</div>
                <a href="salary-structure.html" class="nav-item">
                    <span class="nav-icon">🏗️</span>
                    Salary Structure
                </a>
                <a href="tax-management.html" class="nav-item">
                    <span class="nav-icon">🏛️</span>
                    Tax Management
                </a>
                <a href="benefits.html" class="nav-item">
                    <span class="nav-icon">🏥</span>
                    Benefits
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">Operations</div>
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">📊</span>
                    Dashboard
                </a>
                <a href="finance.html" class="nav-item">
                    <span class="nav-icon">💰</span>
                    Finance
                </a>
                <a href="admin.html" class="nav-item">
                    <span class="nav-icon">⚙️</span>
                    System Admin
                </a>
            </div>
        </nav>

        <main class="main-content">
            <div class="header">
                <h1>Payroll Management</h1>
                <div>
                    <span class="offline-status" id="offlineStatus">Offline</span>
                </div>
            </div>

            <!-- Enhanced Toolbar -->
            <div class="toolbar">
                <button class="btn-primary" onclick="openPayrollModal()">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">➕</span>
                    Add Payroll Entry
                </button>
                <button class="btn-success" onclick="processPayroll()">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">⚡</span>
                    Process Payroll
                </button>
                <button class="btn-secondary" onclick="importAttendanceData()">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">⏱️</span>
                    Import Attendance
                </button>
                <button class="btn-success" onclick="exportPayrollData()">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">📤</span>
                    Export Data
                </button>
                <button class="btn-danger" onclick="clearAllData()">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">🗑️</span>
                    Clear All
                </button>
            </div>

            <!-- Payroll Statistics -->
            <div class="stats-grid">
                <div class="stat-card" onclick="viewEmployees()">
                    <div class="stat-number" id="totalEmployees">0</div>
                    <div class="stat-label">Total Employees</div>
                    <div class="stat-trend trend-up" id="employeeTrend">↑ 0 this month</div>
                </div>
                <div class="stat-card" onclick="viewTotalPayroll()">
                    <div class="stat-number" id="totalPayroll">TZS 0.00</div>
                    <div class="stat-label">Total Payroll</div>
                    <div class="stat-trend trend-up" id="payrollTrend">↑ 0% from last month</div>
                </div>
                <div class="stat-card" onclick="viewAverageSalary()">
                    <div class="stat-number" id="avgSalary">TZS 0.00</div>
                    <div class="stat-label">Average Salary</div>
                    <div class="stat-trend trend-up" id="salaryTrend">↑ 0% change</div>
                </div>
                <div class="stat-card" onclick="viewPendingApprovals()">
                    <div class="stat-number" id="pendingApprovals">0</div>
                    <div class="stat-label">Pending Approvals</div>
                    <div class="stat-trend trend-down" id="approvalTrend">↓ 0 today</div>
                </div>
            </div>

            <!-- Payroll Overview -->
            <div class="payroll-overview">
                <div class="overview-card">
                    <div class="card-header">
                        <div class="card-title">Payroll Distribution</div>
                        <select id="payrollPeriod" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background);">
                            <option>Current Month</option>
                            <option>Last Month</option>
                            <option>This Quarter</option>
                        </select>
                    </div>
                    <div class="chart-container" id="payrollChart">
                        Payroll Distribution Visualization
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-header">
                        <div class="card-title">Quick Actions</div>
                    </div>
                    <div class="quick-actions">
                        <div class="action-btn" onclick="calculateBonuses()">
                            <div class="action-icon">💰</div>
                            <div>Calculate Bonuses</div>
                        </div>
                        <div class="action-btn" onclick="generatePayslips()">
                            <div class="action-icon">📄</div>
                            <div>Generate Payslips</div>
                        </div>
                        <div class="action-btn" onclick="taxCalculations()">
                            <div class="action-icon">🏛️</div>
                            <div>Tax Calculations</div>
                        </div>
                        <div class="action-btn" onclick="runReports()">
                            <div class="action-icon">📊</div>
                            <div>Run Reports</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section A - Payroll Data -->
            <div class="section-header">Section A - Payroll Data</div>
            <div class="table-section">
                <div class="card-header">
                    <div class="card-title">Employee Payroll Records</div>
                    <div class="file-upload-group">
                        <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="handleCSVUpload(this.files[0])">
                        <button class="btn-secondary" onclick="document.getElementById('csvUpload').click()">
                            📤 Upload CSV
                        </button>
                        <button class="btn-secondary" onclick="downloadSampleCSV()">
                            📥 Sample CSV
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="payrollTable">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>S/No</th>
                                <th>Date</th>
                                <th>Employee Name</th>
                                <th>Employee ID</th>
                                <th>Currency</th>
                                <th>Hourly Rate (Normal)</th>
                                <th>Hourly Rate (Overtime)</th>
                                <th>Hours Worked (Normal)</th>
                                <th>Hours Worked (Overtime)</th>
                                <th>Days Worked (Normal)</th>
                                <th>Days Worked (Overtime)</th>
                                <th>Normal Amount</th>
                                <th>Overtime Amount</th>
                                <th>Total Amount</th>
                                <th>Bonus</th>
                                <th>Allowance</th>
                                <th>Deduction</th>
                                <th>Gross Salary</th>
                                <th>PAYEE %</th>
                                <th>Net Salary</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section B - Summary -->
            <div class="section-header">Section B - Summary</div>
            <div class="table-section">
                <div class="table-container">
                    <table id="summaryTable">
                        <thead>
                            <tr>
                                <th>Total Employees</th>
                                <th>Normal Amount Total</th>
                                <th>Overtime Amount Total</th>
                                <th>Total Amount</th>
                                <th>Bonus Total</th>
                                <th>Allowance Total</th>
                                <th>Deduction Total</th>
                                <th>Gross Salary Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="summaryRow">
                                <td>0</td>
                                <td>TZS 0.00</td>
                                <td>TZS 0.00</td>
                                <td>TZS 0.00</td>
                                <td>TZS 0.00</td>
                                <td>TZS 0.00</td>
                                <td>TZS 0.00</td>
                                <td>TZS 0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="footer">
                Copyright © 2025 😀
            </div>
        </main>
    </div>

    <!-- Enhanced Modal -->
    <div id="payrollModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Payroll Entry</h3>
                <button onclick="closePayrollModal()">✖</button>
            </div>
            <form id="payrollForm" onsubmit="savePayrollEntry(event)">
                <div class="form-grid" id="payrollFormFields">
                    <!-- Dynamic form fields will be loaded here -->
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" type="submit">Save Entry</button>
                    <button class="btn-secondary" type="button" onclick="closePayrollModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Enhanced Payroll Management System
        class PayrollManager {
            constructor() {
                this.payrollData = JSON.parse(localStorage.getItem('payrollData')) || [];
                this.currencies = ["TZS", "USD", "EUR", "GBP", "ZAR", "KES", "ZMW", "NAD"];
                this.fields = [
                    "Date", "Employee Name", "Employee ID", "Currency", 
                    "Hourly Rate (Normal Shift)", "Hourly Rate (Overtime)",
                    "Hours Worked (Normal Shift)", "Hours Worked (Overtime)", 
                    "Days Worked (Normal Shift)", "Days Worked (Overtime)",
                    "(Normal Working Day) Total Amount", "(OverTime) Total Amount", 
                    "Total Amount", "Bonus", "Allowance", "Deduction",
                    "Gross Salary", "PAYEE %", "Net Salary", "Remarks"
                ];
                this.initialize();
            }

            initialize() {
                this.setupNavigation();
                this.renderPayrollForm();
                this.loadPayrollData();
                this.setupEventListeners();
                this.setupOfflineDetection();
            }

            setupNavigation() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.href === window.location.href) {
                        item.classList.add('active');
                    }
                });
            }

            renderPayrollForm() {
                const form = document.getElementById('payrollFormFields');
                form.innerHTML = '';

                this.fields.forEach(field => {
                    if (["(Normal Working Day) Total Amount", "(OverTime) Total Amount", 
                         "Total Amount", "Gross Salary", "Net Salary"].includes(field)) return;

                    const label = document.createElement('label');
                    label.textContent = field;
                    label.htmlFor = field;

                    if (field === "Currency") {
                        const select = document.createElement('select');
                        select.name = field;
                        select.id = field;
                        select.required = true;
                        
                        this.currencies.forEach(currency => {
                            const option = document.createElement('option');
                            option.value = currency;
                            option.textContent = currency;
                            select.appendChild(option);
                        });
                        
                        form.appendChild(label);
                        form.appendChild(select);
                        return;
                    }

                    const input = document.createElement('input');
                    input.type = field === "Date" ? "date" : 
                                ["Hourly Rate (Normal Shift)", "Hourly Rate (Overtime)",
                                 "Hours Worked (Normal Shift)", "Hours Worked (Overtime)",
                                 "Days Worked (Normal Shift)", "Days Worked (Overtime)",
                                 "Bonus", "Allowance", "Deduction", "PAYEE %"].includes(field) ? "number" : "text";
                    input.name = field;
                    input.id = field;
                    input.step = field.includes("Rate") || field.includes("Bonus") || 
                                field.includes("Allowance") || field.includes("Deduction") ? "0.01" : "1";
                    input.min = "0";
                    input.required = ["Date", "Employee Name", "Employee ID"].includes(field);

                    form.appendChild(label);
                    form.appendChild(input);
                });
            }

            loadPayrollData() {
                this.renderPayrollTable();
                this.updateSummary();
                this.updateStats();
                this.updateCharts();
            }

            renderPayrollTable() {
                const tbody = document.getElementById('payrollTableBody');
                
                if (this.payrollData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="23" style="text-align: center; color: var(--text-light); padding: 2rem;">
                                No payroll records found. Click "Add Payroll Entry" to get started.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.payrollData.map((row, index) => `
                    <tr class="${row.locked ? 'locked' : ''}">
                        <td><input type="checkbox" class="selectRow" onchange="updateSelections()"></td>
                        <td>${index + 1}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Date', this)">${row.Date}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Employee Name', this)">${row['Employee Name']}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Employee ID', this)">${row['Employee ID']}</td>
                        <td>
                            <select class="currency-select" onchange="updateField(${index}, 'Currency', this)" ${row.locked ? 'disabled' : ''}>
                                ${this.currencies.map(curr => 
                                    `<option value="${curr}" ${row.Currency === curr ? 'selected' : ''}>${curr}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Hourly Rate (Normal Shift)', this)">${row['Hourly Rate (Normal Shift)']}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Hourly Rate (Overtime)', this)">${row['Hourly Rate (Overtime)']}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Hours Worked (Normal Shift)', this)">${row['Hours Worked (Normal Shift)']}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Hours Worked (Overtime)', this)">${row['Hours Worked (Overtime)']}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Days Worked (Normal Shift)', this)">${row['Days Worked (Normal Shift)']}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Days Worked (Overtime)', this)">${row['Days Worked (Overtime)']}</td>
                        <td class="amount-cell">${this.formatCurrency(row['(Normal Working Day) Total Amount'])}</td>
                        <td class="amount-cell">${this.formatCurrency(row['(OverTime) Total Amount'])}</td>
                        <td class="amount-cell">${this.formatCurrency(row['Total Amount'])}</td>
                        <td class="amount-cell">${this.formatCurrency(row.Bonus)}</td>
                        <td class="amount-cell">${this.formatCurrency(row.Allowance)}</td>
                        <td class="amount-cell negative-amount">${this.formatCurrency(row.Deduction)}</td>
                        <td class="amount-cell positive-amount">${this.formatCurrency(row['Gross Salary'])}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'PAYEE %', this)">${row['PAYEE %']}</td>
                        <td class="amount-cell positive-amount">${this.formatCurrency(row['Net Salary'])}</td>
                        <td contenteditable="true" onblur="updateField(${index}, 'Remarks', this)">${row.Remarks || ''}</td>
                        <td class="actions">
                            <button class="btn-warning" onclick="toggleLock(${index})">
                                ${row.locked ? '🔓' : '🔒'}
                            </button>
                            <button class="btn-danger" onclick="deleteEntry(${index})">
                                🗑️
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            formatCurrency(amount) {
                return `TZS ${parseFloat(amount || 0).toFixed(2)}`;
            }

            calculatePayroll(entry) {
                const normalRate = parseFloat(entry['Hourly Rate (Normal Shift)']) || 0;
                const overtimeRate = parseFloat(entry['Hourly Rate (Overtime)']) || 0;
                const normalHours = parseFloat(entry['Hours Worked (Normal Shift)']) || 0;
                const overtimeHours = parseFloat(entry['Hours Worked (Overtime)']) || 0;
                const normalDays = parseFloat(entry['Days Worked (Normal Shift)']) || 1;
                const overtimeDays = parseFloat(entry['Days Worked (Overtime)']) || 1;

                entry['(Normal Working Day) Total Amount'] = (normalRate * normalHours * normalDays).toFixed(2);
                entry['(OverTime) Total Amount'] = (overtimeRate * overtimeHours * overtimeDays).toFixed(2);
                entry['Total Amount'] = (parseFloat(entry['(Normal Working Day) Total Amount']) + 
                                       parseFloat(entry['(OverTime) Total Amount'])).toFixed(2);

                const bonus = parseFloat(entry.Bonus) || 0;
                const allowance = parseFloat(entry.Allowance) || 0;
                const deduction = parseFloat(entry.Deduction) || 0;
                const payeePercent = parseFloat(entry['PAYEE %']) || 0;

                entry['Gross Salary'] = (parseFloat(entry['Total Amount']) + bonus + allowance - deduction).toFixed(2);
                entry['Net Salary'] = (parseFloat(entry['Gross Salary']) * (1 - payeePercent / 100)).toFixed(2);

                return entry;
            }

            updateSummary() {
                const totals = {
                    employees: this.payrollData.length,
                    normal: 0,
                    overtime: 0,
                    total: 0,
                    bonus: 0,
                    allowance: 0,
                    deduction: 0,
                    gross: 0
                };

                this.payrollData.forEach(entry => {
                    totals.normal += parseFloat(entry['(Normal Working Day) Total Amount']) || 0;
                    totals.overtime += parseFloat(entry['(OverTime) Total Amount']) || 0;
                    totals.total += parseFloat(entry['Total Amount']) || 0;
                    totals.bonus += parseFloat(entry.Bonus) || 0;
                    totals.allowance += parseFloat(entry.Allowance) || 0;
                    totals.deduction += parseFloat(entry.Deduction) || 0;
                    totals.gross += parseFloat(entry['Gross Salary']) || 0;
                });

                const row = document.getElementById('summaryRow');
                if (row) {
                    row.innerHTML = `
                        <td>${totals.employees}</td>
                        <td>${this.formatCurrency(totals.normal)}</td>
                        <td>${this.formatCurrency(totals.overtime)}</td>
                        <td>${this.formatCurrency(totals.total)}</td>
                        <td>${this.formatCurrency(totals.bonus)}</td>
                        <td>${this.formatCurrency(totals.allowance)}</td>
                        <td>${this.formatCurrency(totals.deduction)}</td>
                        <td>${this.formatCurrency(totals.gross)}</td>
                    `;
                }
            }

            updateStats() {
                const totalEmployees = this.payrollData.length;
                const totalPayroll = this.payrollData.reduce((sum, entry) => 
                    sum + (parseFloat(entry['Gross Salary']) || 0), 0);
                const avgSalary = totalEmployees > 0 ? totalPayroll / totalEmployees : 0;

                document.getElementById('totalEmployees').textContent = totalEmployees;
                document.getElementById('totalPayroll').textContent = this.formatCurrency(totalPayroll);
                document.getElementById('avgSalary').textContent = this.formatCurrency(avgSalary);
                document.getElementById('pendingApprovals').textContent = 
                    this.payrollData.filter(entry => !entry.approved).length;
            }

            updateCharts() {
                const chart = document.getElementById('payrollChart');
                // Simple chart visualization
                chart.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: end; justify-content: center; gap: 20px; padding: 20px;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="background: var(--primary); width: 50px; height: 70%; border-radius: 4px;"></div>
                            <div style="margin-top: 10px; font-size: 0.875rem;">Normal</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="background: var(--warning); width: 50px; height: 40%; border-radius: 4px;"></div>
                            <div style="margin-top: 10px; font-size: 0.875rem;">Overtime</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="background: var(--success); width: 50px; height: 60%; border-radius: 4px;"></div>
                            <div style="margin-top: 10px; font-size: 0.875rem;">Bonus</div>
                        </div>
                    </div>
                `;
            }

            setupEventListeners() {
                document.getElementById('payrollPeriod').addEventListener('change', (e) => {
                    this.filterByPeriod(e.target.value);
                });
            }

            setupOfflineDetection() {
                window.addEventListener('online', () => {
                    document.getElementById('offlineStatus').style.display = 'none';
                });

                window.addEventListener('offline', () => {
                    document.getElementById('offlineStatus').style.display = 'inline-block';
                });

                if (!navigator.onLine) {
                    document.getElementById('offlineStatus').style.display = 'inline-block';
                }
            }

            filterByPeriod(period) {
                console.log('Filtering payroll by period:', period);
                this.updateCharts();
            }
        }

        // Global payroll functions
        const payrollManager = new PayrollManager();

        function openPayrollModal() {
            document.getElementById('payrollModal').style.display = 'flex';
        }

        function closePayrollModal() {
            document.getElementById('payrollModal').style.display = 'none';
            document.getElementById('payrollForm').reset();
        }

        function savePayrollEntry(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const entry = {};

            payrollManager.fields.forEach(field => {
                if (["(Normal Working Day) Total Amount", "(OverTime) Total Amount", 
                     "Total Amount", "Gross Salary", "Net Salary"].includes(field)) return;
                
                entry[field] = formData.get(field) || (field === 'Remarks' ? '' : '0');
            });

            // Convert numeric fields
            ["Hourly Rate (Normal Shift)", "Hourly Rate (Overtime)", "Hours Worked (Normal Shift)", 
             "Hours Worked (Overtime)", "Days Worked (Normal Shift)", "Days Worked (Overtime)",
             "Bonus", "Allowance", "Deduction", "PAYEE %"].forEach(field => {
                entry[field] = parseFloat(entry[field]) || 0;
            });

            // Calculate payroll
            payrollManager.calculatePayroll(entry);

            payrollManager.payrollData.push(entry);
            localStorage.setItem('payrollData', JSON.stringify(payrollManager.payrollData));
            
            payrollManager.loadPayrollData();
            closePayrollModal();
            
            alert('Payroll entry saved successfully!');
        }

        function updateField(index, field, element) {
            if (confirm('Save changes?')) {
                payrollManager.payrollData[index][field] = element.value;
                
                // Recalculate if it's a numeric field
                if (["Hourly Rate (Normal Shift)", "Hourly Rate (Overtime)", 
                     "Hours Worked (Normal Shift)", "Hours Worked (Overtime)",
                     "Days Worked (Normal Shift)", "Days Worked (Overtime)",
                     "Bonus", "Allowance", "Deduction", "PAYEE %"].includes(field)) {
                    payrollManager.calculatePayroll(payrollManager.payrollData[index]);
                }
                
                localStorage.setItem('payrollData', JSON.stringify(payrollManager.payrollData));
                payrollManager.loadPayrollData();
            } else {
                payrollManager.renderPayrollTable();
            }
        }

        function toggleLock(index) {
            payrollManager.payrollData[index].locked = !payrollManager.payrollData[index].locked;
            localStorage.setItem('payrollData', JSON.stringify(payrollManager.payrollData));
            payrollManager.renderPayrollTable();
        }

        function deleteEntry(index) {
            if (confirm('Delete this payroll entry?')) {
                payrollManager.payrollData.splice(index, 1);
                localStorage.setItem('payrollData', JSON.stringify(payrollManager.payrollData));
                payrollManager.loadPayrollData();
            }
        }

        function processPayroll() {
            if (payrollManager.payrollData.length === 0) {
                alert('No payroll data to process. Please add entries first.');
                return;
            }
            alert('Processing payroll for ' + payrollManager.payrollData.length + ' employees...');
            // Integration with finance system would go here
        }

        function importAttendanceData() {
            alert('Importing data from Attendance system...');
            // Integration with attendance system
            window.location.href = 'attendance.html';
        }

        function exportPayrollData() {
            if (payrollManager.payrollData.length === 0) {
                alert('No data to export.');
                return;
            }
            alert('Exporting payroll data...');
            // Export functionality would go here
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all payroll data? This action cannot be undone.')) {
                payrollManager.payrollData = [];
                localStorage.setItem('payrollData', JSON.stringify([]));
                payrollManager.loadPayrollData();
                alert('All payroll data cleared.');
            }
        }

        function calculateBonuses() {
            alert('Calculating employee bonuses...');
        }

        function generatePayslips() {
            alert('Generating employee payslips...');
        }

        function taxCalculations() {
            alert('Running tax calculations...');
        }

        function runReports() {
            alert('Generating payroll reports...');
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
        }
    </script>
</body>
</html>
