<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Engagement & CSR - CephasGM ERP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* === [Existing Styles from your community.html - Kept Intact] === */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --community-green: #059669;
            --community-teal: #0d9488;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        .logo-icon {
            width: 40px; height: 40px; background: var(--primary); border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 1.25rem;
        }
        .nav-section { margin-bottom: 2rem; }
        .nav-title {
            font-size: 0.75rem; text-transform: uppercase; color: var(--text-light);
            margin-bottom: 1rem; padding: 0 1rem; letter-spacing: 0.5px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            border-radius: 8px; color: var(--text-light); text-decoration: none;
            transition: all 0.2s; margin-bottom: 0.25rem; border: none;
            background: none; width: 100%; text-align: left; cursor: pointer;
            font-size: 0.95rem; position: relative;
        }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { font-size: 1.25rem; width: 24px; text-align: center; }
        .main-content { grid-column: 2; padding: 2rem; margin-left: 280px; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
        }
        .header h1 { font-size: 1.875rem; font-weight: 700; }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--background); }
        .btn-community { background: linear-gradient(135deg, var(--community-green), var(--community-teal)); color: white; }
        .btn-community:hover { background: linear-gradient(135deg, #047857, #0f766e); }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--surface); padding: 1.5rem; border-radius: 12px;
            border: 1px solid var(--border); text-align: center; box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-light); font-size: 0.9rem; }
        .impact-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .impact-card {
            background: var(--surface); padding: 1.5rem; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: var(--shadow); transition: transform 0.2s;
        }
        .impact-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .card-icon {
            width: 50px; height: 50px; border-radius: 10px; display: flex;
            align-items: center; justify-content: center; font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), #3b82f6); color: white;
        }
        .card-title { font-size: 1.25rem; font-weight: 600; }
        .impact-list { list-style: none; }
        .impact-item {
            padding: 0.75rem 0; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            transition: background-color 0.2s;
        }
        .impact-item:hover {
            background-color: var(--background); border-radius: 6px;
            padding-left: 0.5rem; padding-right: 0.5rem;
        }
        .impact-item:last-child { border-bottom: none; }
        .impact-name { font-weight: 500; }
        .impact-value { font-weight: 600; color: var(--primary); }
        .events-section {
            background: var(--surface); border-radius: 12px; border: 1px solid var(--border);
            padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow);
        }
        .events-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .events-title { font-size: 1.25rem; font-weight: 600; }
        .events-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;
        }
        .event-card {
            background: var(--background); padding: 1.5rem; border-radius: 8px;
            border: 1px solid var(--border); transition: transform 0.2s; box-shadow: var(--shadow);
        }
        .event-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .event-date { font-size: 0.875rem; color: var(--primary); font-weight: 600; margin-bottom: 0.5rem; }
        .event-title { font-weight: 600; margin-bottom: 0.5rem; }
        .event-description { color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem; }
        .event-actions { display: flex; gap: 0.5rem; }
        .event-btn {
            padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px;
            background: var(--surface); cursor: pointer; font-size: 0.875rem;
            transition: all 0.2s; display: flex; align-items: center; gap: 0.25rem;
        }
        .event-btn:hover { transform: translateY(-1px); }
        .event-btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .volunteer-section {
            background: var(--surface); border-radius: 12px; border: 1px solid var(--border);
            padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow);
        }
        .volunteer-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .volunteer-stat {
            text-align: center; padding: 1rem; background: var(--background);
            border-radius: 8px; transition: transform 0.2s;
        }
        .volunteer-stat:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .volunteer-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .volunteer-label { font-size: 0.875rem; color: var(--text-light); }
        .module-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem; margin-bottom: 3rem;
        }
        .module-card {
            background: var(--surface); padding: 2rem; border-radius: 12px;
            border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease;
            text-decoration: none; color: inherit; display: block;
            box-shadow: var(--shadow); position: relative;
        }
        .module-card:hover {
            transform: translateY(-4px); box-shadow: var(--shadow-lg);
            border-color: var(--community-green);
        }
        .module-icon {
            width: 60px; height: 60px; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 1.75rem;
            margin-bottom: 1rem; background: linear-gradient(135deg, var(--community-green), var(--community-teal));
            color: white;
        }
        .module-card h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .module-card p { color: var(--text-light); font-size: 0.95rem; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text {
            visibility: hidden; width: 200px; background-color: var(--text); color: white;
            text-align: center; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 0.875rem;
        }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .footer { text-align: center; padding: 2rem; margin-top: 3rem; color: var(--text-light); border-top: 1px solid var(--border); }
        .language-selector { display: flex; align-items: center; gap: 0.5rem; }
        .language-selector select {
            padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface); color: var(--text);
        }
        .mobile-nav-toggle {
            display: none; position: fixed; top: 1rem; left: 1rem; z-index: 1000;
            background: var(--primary); color: white; border: none; border-radius: 8px;
            width: 40px; height: 40px; align-items: center; justify-content: center; cursor: pointer;
        }
        .dark-mode-toggle {
            background: none; border: none; font-size: 1.25rem; cursor: pointer;
            color: var(--text-light); padding: 0.5rem; border-radius: 6px; transition: all 0.2s;
        }
        .dark-mode-toggle:hover { background: var(--background); color: var(--text); }
        .currency-selector { display: flex; align-items: center; gap: 0.5rem; }
        .currency-selector select {
            padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface); color: var(--text);
        }
        .impact-dashboard {
            background: var(--surface); border-radius: 12px; padding: 1.5rem;
            margin-bottom: 2rem; border: 1px solid var(--border); box-shadow: var(--shadow);
        }
        .dashboard-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
        .impact-chart {
            background: var(--background); border-radius: 8px; padding: 1.5rem;
            min-height: 250px; display: flex; align-items: center; justify-content: center;
            color: var(--text-light); flex-direction: column;
        }
        .impact-metrics { display: flex; flex-direction: column; gap: 1rem; }
        .impact-metric {
            background: var(--background); padding: 1rem; border-radius: 8px;
            text-align: center; transition: transform 0.2s;
        }
        .impact-metric:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .metric-value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
        .metric-label { font-size: 0.875rem; color: var(--text-light); margin-top: 0.25rem; }
        @media (max-width: 1024px) {
            .dashboard { grid-template-columns: 1fr; }
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; grid-column: 1; padding: 1rem; }
            .mobile-nav-toggle { display: flex; }
            .header { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; justify-content: space-between; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .module-grid { grid-template-columns: 1fr; }
            .impact-grid { grid-template-columns: 1fr; }
            .events-grid { grid-template-columns: 1fr; }
            .volunteer-stats { grid-template-columns: repeat(2, 1fr); }
        }
        .dark-mode {
            --background: #0f172a; --surface: #1e293b; --text: #f1f5f9;
            --text-light: #94a3b8; --border: #334155;
        }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        button:focus, a:focus, select:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
        .csv-upload-container {
            background: var(--surface); border: 2px dashed var(--border); border-radius: 12px;
            padding: 2rem; text-align: center; margin-bottom: 2rem; transition: all 0.3s;
        }
        .csv-upload-container:hover { border-color: var(--primary); }
        .csv-upload-container.dragover { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); }

        /* === NEW STYLES for Upgraded Functionality (Modals, Forms, Edit/Delete) === */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--surface); margin: auto; padding: 2rem;
            border: 1px solid var(--border); border-radius: 12px;
            width: 90%; max-width: 600px; box-shadow: var(--shadow-lg);
            position: relative; max-height: 80vh; overflow-y: auto;
        }
        .modal-content h2 { margin-bottom: 1.5rem; color: var(--primary); }
        .modal-close {
            position: absolute; top: 1rem; right: 1.5rem; color: var(--text-light);
            font-size: 1.8rem; font-weight: bold; cursor: pointer;
        }
        .modal-close:hover { color: var(--error); }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem; color: var(--text-light);}
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border);
            border-radius: 6px; background: var(--background); color: var(--text);
            font-family: inherit;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .edit-icon, .delete-icon {
            cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px;
            color: var(--text-light); transition: all 0.2s;
            font-size: 0.9rem; margin-left: 0.5rem;
        }
        .edit-icon:hover { color: var(--primary); background: var(--background); }
        .delete-icon:hover { color: var(--error); background: var(--background); }
        .impact-header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .view-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .view-btn {
            padding: 0.5rem 1rem; border: 1px solid var(--border); background: var(--surface);
            border-radius: 6px; cursor: pointer; color: var(--text);
        }
        .view-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .data-table {
            width: 100%; border-collapse: collapse; background: var(--surface);
            border-radius: 8px; overflow: hidden; box-shadow: var(--shadow);
        }
        .data-table th {
            background: var(--background); padding: 0.75rem; text-align: left;
            font-weight: 600; color: var(--text); border-bottom: 2px solid var(--border);
        }
        .data-table td { padding: 0.75rem; border-bottom: 1px solid var(--border); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background: var(--background); }
        .toast {
            visibility: hidden; min-width: 250px; background-color: var(--success);
            color: white; text-align: center; border-radius: 8px; padding: 1rem;
            position: fixed; z-index: 1001; bottom: 30px; left: 50%;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s;
            box-shadow: var(--shadow-lg);
        }
        .toast.show { visibility: visible; opacity: 1; }
        .toast.error { background-color: var(--error); }
        .stat-number.editable, .impact-value.editable { cursor: pointer; }
        .badge {
            display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px;
            font-size: 0.75rem; font-weight: 600;
        }
        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-error { background: var(--error); color: white; }
    </style>
</head>
<body>
    <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
    </button>

    <div class="dashboard">
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">CG</div>
                <div>
                    <div style="font-weight: 700; font-size: 1.25rem;">CephasGM</div>
                    <div style="font-size: 0.875rem; color: var(--text-light);">ERP System</div>
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Community & CSR</div>
                <a href="community.html" class="nav-item active"><span class="nav-icon">ü§ù</span>Community Engagement</a>
                <a href="sustainability.html" class="nav-item"><span class="nav-icon">üå±</span>Sustainability</a>
                <a href="philanthropy.html" class="nav-item"><span class="nav-icon">üíù</span>Philanthropy</a>
            </div>
            <div class="nav-section">
                <div class="nav-title">Social Programs</div>
                <a href="volunteering.html" class="nav-item"><span class="nav-icon">üë•</span>Employee Volunteering</a>
                <a href="education.html" class="nav-item"><span class="nav-icon">üéì</span>Education Support</a>
                <a href="health-initiatives.html" class="nav-item"><span class="nav-icon">üè•</span>Health Initiatives</a>
            </div>
            <div class="nav-section">
                <div class="nav-title">Operations</div>
                <a href="index.html" class="nav-item"><span class="nav-icon">üìä</span>Dashboard</a>
                <a href="hr.html" class="nav-item"><span class="nav-icon">üë•</span>HR Management</a>
                <a href="finance.html" class="nav-item"><span class="nav-icon">üí≥</span>Finance</a>
                <a href="payroll.html" class="nav-item"><span class="nav-icon">üí∞</span>Payroll</a>
            </div>
            <div class="nav-section">
                <div class="nav-title">User</div>
                <div class="nav-item"><span class="nav-icon">üë§</span><span id="userRole">CSR Manager (Admin)</span></div>
                <button class="nav-item" id="logoutBtn"><span class="nav-icon">üö™</span>Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="header">
                <div>
                    <h1>Community Engagement & CSR</h1>
                    <div style="color: var(--text-light);">Corporate Social Responsibility, community development, and social impact initiatives</div>
                </div>
                <div class="header-actions">
                    <div class="currency-selector">
                        <span>Currency:</span>
                        <select id="currencySelect">
                            <option value="TZS">TZS - Tanzanian Shilling</option><option value="USD">USD - US Dollar</option><option value="EUR">EUR - Euro</option><option value="GBP">GBP - British Pound</option><option value="KES">KES - Kenyan Shilling</option>
                        </select>
                    </div>
                    <div class="language-selector">
                        <span>Language:</span>
                        <select id="languageSelect">
                            <option value="en">English</option><option value="sw">Swahili</option>
                        </select>
                    </div>
                    <button class="dark-mode-toggle" id="darkModeToggle"><i class="fas fa-moon"></i></button>
                    <button class="btn btn-community" id="newProgramBtn"><i class="fas fa-plus"></i> New Program</button>
                </div>
            </div>

            <!-- Stats Grid with Edit/Drill-Down -->
            <div class="stats-grid">
                <div class="stat-card" onclick="window.openModule('csr-program-management')">
                    <div class="stat-number" id="csrInvestmentDisplay">‚Ç¶12.5M</div>
                    <div class="stat-label">CSR Investment <i class="fas fa-edit edit-icon" onclick="editStat('csrInvestment', event)"></i></div>
                </div>
                <div class="stat-card" onclick="window.openModule('impact-assessment')">
                    <div class="stat-number" id="peopleImpactedDisplay">2,450</div>
                    <div class="stat-label">People Impacted <i class="fas fa-edit edit-icon" onclick="editStat('peopleImpacted', event)"></i></div>
                </div>
                <div class="stat-card" onclick="window.openModule('volunteer-management')">
                    <div class="stat-number" id="volunteerHoursDisplay">156</div>
                    <div class="stat-label">Volunteer Hours <i class="fas fa-edit edit-icon" onclick="editStat('volunteerHours', event)"></i></div>
                </div>
                <div class="stat-card" onclick="window.openModule('csr-program-management')">
                    <div class="stat-number" id="activeProgramsDisplay">24</div>
                    <div class="stat-label">Active Programs <i class="fas fa-edit edit-icon" onclick="editStat('activePrograms', event)"></i></div>
                </div>
            </div>

            <!-- Community Impact Dashboard (Now fully interactive) -->
            <div class="impact-dashboard">
                <div class="dashboard-title">Community Impact Overview
                    <span style="float:right; font-size:0.9rem;"><i class="fas fa-sync-alt" onclick="refreshImpactMetrics()" style="cursor:pointer;"></i></span>
                </div>
                <div class="dashboard-grid">
                    <div class="impact-chart" id="impactChart">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <div id="chartSummary">Program Success Rate: 89%</div>
                        <br><small style="opacity: 0.7;">Click <i class="fas fa-sliders-h" onclick="showChartCustomizer()" style="cursor:pointer;"></i> to customize</small>
                    </div>
                    <div class="impact-metrics" id="impactMetricsContainer">
                        <div class="impact-metric" data-metric="successRate">
                            <div class="metric-value" id="successRateMetric">89%</div>
                            <div class="metric-label">Program Success Rate <i class="fas fa-edit edit-icon" onclick="editMetric('successRate', event)"></i></div>
                        </div>
                        <div class="impact-metric" data-metric="partners">
                            <div class="metric-value" id="partnersMetric">42</div>
                            <div class="metric-label">Community Partners <i class="fas fa-edit edit-icon" onclick="editMetric('partners', event)"></i></div>
                        </div>
                        <div class="impact-metric" data-metric="satisfaction">
                            <div class="metric-value" id="satisfactionMetric">96%</div>
                            <div class="metric-label">Stakeholder Satisfaction <i class="fas fa-edit edit-icon" onclick="editMetric('satisfaction', event)"></i></div>
                        </div>
                        <div class="impact-metric" data-metric="awards">
                            <div class="metric-value" id="awardsMetric">15</div>
                            <div class="metric-label">Awards Received <i class="fas fa-edit edit-icon" onclick="editMetric('awards', event)"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSR Impact Dashboard Cards (Now fully editable data) -->
            <div class="impact-grid" id="impactGridCards">
                <!-- Education Initiatives Card -->
                <div class="impact-card" data-category="education" data-id="edu1">
                    <div class="card-header">
                        <div class="card-icon">üéì</div>
                        <div class="impact-header-actions">
                            <span class="card-title">Education Initiatives</span>
                            <i class="fas fa-edit edit-icon" onclick="editImpactCard('edu1')"></i>
                            <i class="fas fa-trash delete-icon" onclick="deleteImpactCard('edu1')"></i>
                        </div>
                    </div>
                    <ul class="impact-list" id="edu1-list">
                        <li class="impact-item"><span class="impact-name">Scholarships Awarded</span><span class="impact-value" data-key="scholarships">42</span></li>
                        <li class="impact-item"><span class="impact-name">Schools Supported</span><span class="impact-value" data-key="schools">8</span></li>
                        <li class="impact-item"><span class="impact-name">Computer Labs Built</span><span class="impact-value" data-key="labs">3</span></li>
                        <li class="impact-item"><span class="impact-name">Teachers Trained</span><span class="impact-value" data-key="teachers">156</span></li>
                    </ul>
                </div>
                <!-- Health & Wellness Card -->
                <div class="impact-card" data-category="health" data-id="health1">
                    <div class="card-header">
                        <div class="card-icon">üè•</div>
                        <div class="impact-header-actions">
                            <span class="card-title">Health & Wellness</span>
                            <i class="fas fa-edit edit-icon" onclick="editImpactCard('health1')"></i>
                            <i class="fas fa-trash delete-icon" onclick="deleteImpactCard('health1')"></i>
                        </div>
                    </div>
                    <ul class="impact-list" id="health1-list">
                        <li class="impact-item"><span class="impact-name">Medical Camps</span><span class="impact-value" data-key="camps">12</span></li>
                        <li class="impact-item"><span class="impact-name">Patients Treated</span><span class="impact-value" data-key="patients">1,240</span></li>
                        <li class="impact-item"><span class="impact-name">Health Workshops</span><span class="impact-value" data-key="workshops">24</span></li>
                        <li class="impact-item"><span class="impact-name">Vaccinations</span><span class="impact-value" data-key="vaccinations">850</span></li>
                    </ul>
                </div>
                <!-- Environmental Projects Card -->
                <div class="impact-card" data-category="environment" data-id="env1">
                    <div class="card-header">
                        <div class="card-icon">üå±</div>
                        <div class="impact-header-actions">
                            <span class="card-title">Environmental Projects</span>
                            <i class="fas fa-edit edit-icon" onclick="editImpactCard('env1')"></i>
                            <i class="fas fa-trash delete-icon" onclick="deleteImpactCard('env1')"></i>
                        </div>
                    </div>
                    <ul class="impact-list" id="env1-list">
                        <li class="impact-item"><span class="impact-name">Trees Planted</span><span class="impact-value" data-key="trees">5,000</span></li>
                        <li class="impact-item"><span class="impact-name">Clean-up Campaigns</span><span class="impact-value" data-key="cleanups">18</span></li>
                        <li class="impact-item"><span class="impact-name">Recycling Programs</span><span class="impact-value" data-key="recycling">6</span></li>
                        <li class="impact-item"><span class="impact-name">Water Projects</span><span class="impact-value" data-key="water">4</span></li>
                    </ul>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="addNewImpactCard()"><i class="fas fa-plus"></i> Add New Impact Category</button>

            <!-- Upcoming Community Events (Fully Editable) -->
            <div class="events-section">
                <div class="events-header">
                    <div class="events-title">Upcoming Community Events</div>
                    <button class="btn btn-primary" id="newEventBtn"><i class="fas fa-plus"></i> New Event</button>
                </div>
                <div class="events-grid" id="eventsGridContainer">
                    <!-- Events will be populated by JavaScript -->
                </div>
            </div>

            <!-- Volunteer Management (Fully Editable) -->
            <div class="volunteer-section">
                <div class="card-header">
                    <div class="card-icon">üë•</div>
                    <div class="card-title">Employee Volunteering Program</div>
                </div>
                <div class="volunteer-stats" id="volunteerStatsContainer">
                    <div class="volunteer-stat">
                        <div class="volunteer-value" id="activeVolunteers">89</div>
                        <div class="volunteer-label">Active Volunteers <i class="fas fa-edit edit-icon" onclick="editVolunteerStat('activeVolunteers', event)"></i></div>
                    </div>
                    <div class="volunteer-stat">
                        <div class="volunteer-value" id="totalVolunteerHours">1,248</div>
                        <div class="volunteer-label">Total Hours <i class="fas fa-edit edit-icon" onclick="editVolunteerStat('totalVolunteerHours', event)"></i></div>
                    </div>
                    <div class="volunteer-stat">
                        <div class="volunteer-value" id="volunteerValueDisplay">‚Ç¶2.4M</div>
                        <div class="volunteer-label">Value Created <i class="fas fa-edit edit-icon" onclick="editVolunteerStat('volunteerValueDisplay', event)"></i></div>
                    </div>
                    <div class="volunteer-stat">
                        <div class="volunteer-value" id="participationRate">96%</div>
                        <div class="volunteer-label">Participation Rate <i class="fas fa-edit edit-icon" onclick="editVolunteerStat('participationRate', event)"></i></div>
                    </div>
                </div>
                <div style="color: var(--text-light); font-size: 0.875rem;">
                    Our employees have contributed significantly to community development.
                </div>
            </div>

            <!-- Community Engagement Modules (All modules now open detailed views) -->
            <div class="module-grid">
                <div class="module-card tooltip" onclick="window.openModule('csr-program-management')">
                    <div class="module-icon">üìã</div>
                    <h3>CSR Program Management</h3>
                    <p>Plan, track, and manage corporate social responsibility initiatives</p>
                    <span class="tooltip-text">Program lifecycle management with impact tracking</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('community-partnerships')">
                    <div class="module-icon">ü§ù</div>
                    <h3>Community Partnerships</h3>
                    <p>Manage relationships with NGOs, community organizations</p>
                    <span class="tooltip-text">Partnership tracking and collaboration management</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('volunteer-management')">
                    <div class="module-icon">üë•</div>
                    <h3>Volunteer Management</h3>
                    <p>Coordinate employee volunteering, track hours</p>
                    <span class="tooltip-text">Volunteer scheduling and recognition system</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('event-planning')">
                    <div class="module-icon">üé™</div>
                    <h3>Event Planning</h3>
                    <p>Organize community events, charity functions</p>
                    <span class="tooltip-text">Event management with attendance tracking</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('impact-assessment')">
                    <div class="module-icon">üìä</div>
                    <h3>Impact Assessment</h3>
                    <p>Measure and report social impact, CSR effectiveness</p>
                    <span class="tooltip-text">Social ROI calculation and impact analytics</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('grant-management')">
                    <div class="module-icon">üí∏</div>
                    <h3>Grant Management</h3>
                    <p>Manage charitable grants, donations, funding allocations</p>
                    <span class="tooltip-text">Grant application and fund distribution tracking</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('stakeholder-engagement')">
                    <div class="module-icon">üó£Ô∏è</div>
                    <h3>Stakeholder Engagement</h3>
                    <p>Community consultations, stakeholder mapping</p>
                    <span class="tooltip-text">Stakeholder communication and feedback system</span>
                </div>
                <div class="module-card tooltip" onclick="window.openModule('sustainability-reporting')">
                    <div class="module-icon">üåç</div>
                    <h3>Sustainability Reporting</h3>
                    <p>ESG reporting, sustainability metrics</p>
                    <span class="tooltip-text">ESG compliance and sustainability reporting</span>
                </div>
            </div>

            <!-- CSV Upload for Volunteer Data (Now functional) -->
            <div class="csv-upload-container" id="csvUploadContainer">
                <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>Upload Volunteer Data</h3>
                <p>Drag & drop a CSV file or click to browse</p>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button class="btn btn-secondary" onclick="document.getElementById('csvFileInput').click()" style="margin-top: 1rem;">
                    <i class="fas fa-folder-open"></i> Browse Files
                </button>
            </div>

            <div class="footer">Copyright ¬© 2025 üòÄ CephasGM ERP - Community Engagement Module (Fully Upgraded)</div>
        </main>
    </div>

    <!-- Modal for Editing/Adding (Generic) -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Edit Item</h2>
            <form id="editForm" onsubmit="saveModalData(event)">
                <div id="modalFormFields"></div>
                <div class="form-row" style="justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ==================== GLOBAL STATE & INITIALIZATION ====================
        // All data is stored in localStorage for persistence
        let appData = {
            stats: { csrInvestment: 12500000, peopleImpacted: 2450, volunteerHours: 156, activePrograms: 24 },
            impactMetrics: { successRate: 89, partners: 42, satisfaction: 96, awards: 15 },
            impactCards: {
                edu1: { category: 'education', title: 'Education Initiatives', icon: 'üéì', items: { scholarships: 42, schools: 8, labs: 3, teachers: 156 } },
                health1: { category: 'health', title: 'Health & Wellness', icon: 'üè•', items: { camps: 12, patients: 1240, workshops: 24, vaccinations: 850 } },
                env1: { category: 'environment', title: 'Environmental Projects', icon: 'üå±', items: { trees: 5000, cleanups: 18, recycling: 6, water: 4 } }
            },
            events: [
                { id: 'ev1', date: 'Dec 15, 2024 ‚Ä¢ 09:00 AM', title: 'Annual Thanksgiving Celebration', description: 'Community feast and cultural performances', type: 'Charity', volunteersNeeded: 10, volunteersSigned: 3, status: 'Planned' },
                { id: 'ev2', date: 'Dec 20, 2024 ‚Ä¢ 08:00 AM', title: 'Christmas Charity Drive', description: 'Toy and gift distribution', type: 'Fundraiser', volunteersNeeded: 15, volunteersSigned: 7, status: 'Planned' },
                { id: 'ev3', date: 'Jan 10, 2025 ‚Ä¢ 10:00 AM', title: 'Youth Skills Workshop', description: 'Digital skills training', type: 'Workshop', volunteersNeeded: 5, volunteersSigned: 2, status: 'Planned' },
                { id: 'ev4', date: 'Jan 25, 2025 ‚Ä¢ 07:00 AM', title: 'Health Screening', description: 'Free medical checkups', type: 'Health Camp', volunteersNeeded: 8, volunteersSigned: 4, status: 'Planned' }
            ],
            volunteerStats: { activeVolunteers: 89, totalVolunteerHours: 1248, volunteerValue: 2400000, participationRate: 96 }
        };

        // Load from localStorage if available
        function loadAppData() {
            const saved = localStorage.getItem('cephasgm_csr_data');
            if (saved) {
                try { appData = JSON.parse(saved); } catch(e) { console.warn('Failed to load saved data'); }
            }
        }
        function saveAppData() { localStorage.setItem('cephasgm_csr_data', JSON.stringify(appData)); }

        // Initialize data and UI
        loadAppData();
        updateAllUI();

        // ==================== UI UPDATE FUNCTIONS ====================
        function updateAllUI() {
            updateStats();
            updateImpactMetricsUI();
            updateImpactCardsUI();
            updateEventsUI();
            updateVolunteerStatsUI();
            updateCurrencyDisplay();
        }

        function updateStats() {
            document.getElementById('csrInvestmentDisplay').innerText = formatCurrency(appData.stats.csrInvestment);
            document.getElementById('peopleImpactedDisplay').innerText = appData.stats.peopleImpacted.toLocaleString();
            document.getElementById('volunteerHoursDisplay').innerText = appData.stats.volunteerHours.toLocaleString();
            document.getElementById('activeProgramsDisplay').innerText = appData.stats.activePrograms;
        }

        function updateImpactMetricsUI() {
            document.getElementById('successRateMetric').innerText = appData.impactMetrics.successRate + '%';
            document.getElementById('partnersMetric').innerText = appData.impactMetrics.partners;
            document.getElementById('satisfactionMetric').innerText = appData.impactMetrics.satisfaction + '%';
            document.getElementById('awardsMetric').innerText = appData.impactMetrics.awards;
            document.getElementById('chartSummary').innerHTML = `Program Success Rate: ${appData.impactMetrics.successRate}%<br>Community Partners: ${appData.impactMetrics.partners}`;
        }

        function updateImpactCardsUI() {
            const container = document.getElementById('impactGridCards');
            container.innerHTML = '';
            for (const [id, card] of Object.entries(appData.impactCards)) {
                const cardHtml = `
                    <div class="impact-card" data-category="${card.category}" data-id="${id}">
                        <div class="card-header">
                            <div class="card-icon">${card.icon}</div>
                            <div class="impact-header-actions">
                                <span class="card-title">${card.title}</span>
                                <i class="fas fa-edit edit-icon" onclick="editImpactCard('${id}')"></i>
                                <i class="fas fa-trash delete-icon" onclick="deleteImpactCard('${id}')"></i>
                            </div>
                        </div>
                        <ul class="impact-list" id="${id}-list">
                            ${Object.entries(card.items).map(([key, val]) => 
                                `<li class="impact-item"><span class="impact-name">${formatKey(key)}</span><span class="impact-value" data-key="${key}">${val.toLocaleString()}</span></li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
                container.innerHTML += cardHtml;
            }
        }

        function updateEventsUI() {
            const container = document.getElementById('eventsGridContainer');
            container.innerHTML = '';
            appData.events.forEach(event => {
                const eventCard = `
                    <div class="event-card" data-event-id="${event.id}">
                        <div class="event-date">${event.date}</div>
                        <div class="event-title">${event.title}</div>
                        <div class="event-description">${event.description}</div>
                        <div style="font-size:0.8rem; margin-bottom:0.5rem;">Type: ${event.type} | Status: ${event.status}</div>
                        <div class="event-actions">
                            <button class="event-btn primary" onclick="volunteerForEvent('${event.id}')"><i class="fas fa-hands-helping"></i> Volunteer</button>
                            <button class="event-btn" onclick="editEvent('${event.id}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="event-btn" onclick="deleteEvent('${event.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.innerHTML += eventCard;
            });
        }

        function updateVolunteerStatsUI() {
            document.getElementById('activeVolunteers').innerText = appData.volunteerStats.activeVolunteers;
            document.getElementById('totalVolunteerHours').innerText = appData.volunteerStats.totalVolunteerHours;
            document.getElementById('volunteerValueDisplay').innerText = formatCurrency(appData.volunteerStats.volunteerValue);
            document.getElementById('participationRate').innerText = appData.volunteerStats.participationRate + '%';
        }

        function formatKey(key) {
            return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        }

        // ==================== CURRENCY & LOCALIZATION ====================
        const currencyRates = { 'TZS': { rate: 1, symbol: 'TSh' }, 'USD': { rate: 0.00043, symbol: '$' }, 'EUR': { rate: 0.00040, symbol: '‚Ç¨' }, 'GBP': { rate: 0.00034, symbol: '¬£' }, 'KES': { rate: 0.062, symbol: 'KSh' } };
        let currentCurrency = 'TZS';
        document.getElementById('currencySelect').addEventListener('change', function(e) {
            currentCurrency = e.target.value;
            updateCurrencyDisplay();
        });

        function formatCurrency(amountInTZS) {
            const rateInfo = currencyRates[currentCurrency];
            const converted = (amountInTZS * rateInfo.rate).toFixed(2);
            return `${rateInfo.symbol}${parseFloat(converted).toLocaleString()}`;
        }

        function updateCurrencyDisplay() {
            document.getElementById('csrInvestmentDisplay').innerText = formatCurrency(appData.stats.csrInvestment);
            document.getElementById('volunteerValueDisplay').innerText = formatCurrency(appData.volunteerStats.volunteerValue);
        }

        // ==================== EDITING FUNCTIONS (using Modal) ====================
        let currentEditContext = null;

        window.editStat = function(statName, event) {
            event.stopPropagation();
            currentEditContext = { type: 'stat', key: statName };
            showModal(`Edit ${statName}`, [{ name: statName, label: 'New Value', type: 'number', value: appData.stats[statName] }]);
        };

        window.editMetric = function(metricName, event) {
            event.stopPropagation();
            currentEditContext = { type: 'metric', key: metricName };
            showModal(`Edit ${metricName}`, [{ name: metricName, label: 'New Value', type: 'number', value: appData.impactMetrics[metricName] }]);
        };

        window.editImpactCard = function(cardId) {
            const card = appData.impactCards[cardId];
            if (!card) return;
            currentEditContext = { type: 'impactCard', id: cardId };
            const fields = [
                { name: 'title', label: 'Card Title', type: 'text', value: card.title },
                { name: 'icon', label: 'Icon (emoji)', type: 'text', value: card.icon }
            ];
            // Add fields for each item in the card
            Object.entries(card.items).forEach(([key, val]) => {
                fields.push({ name: `item_${key}`, label: formatKey(key), type: 'number', value: val });
            });
            showModal('Edit Impact Card', fields);
        };

        window.editVolunteerStat = function(statName, event) {
            event.stopPropagation();
            currentEditContext = { type: 'volunteerStat', key: statName };
            let value = appData.volunteerStats[statName];
            if (statName === 'volunteerValueDisplay') {
                value = appData.volunteerStats.volunteerValue;
            }
            showModal(`Edit ${statName}`, [{ name: statName, label: 'New Value', type: 'number', value: value }]);
        };

        window.editEvent = function(eventId) {
            const ev = appData.events.find(e => e.id === eventId);
            if (!ev) return;
            currentEditContext = { type: 'event', id: eventId };
            const fields = [
                { name: 'title', label: 'Event Title', type: 'text', value: ev.title },
                { name: 'description', label: 'Description', type: 'textarea', value: ev.description },
                { name: 'date', label: 'Date & Time', type: 'text', value: ev.date },
                { name: 'type', label: 'Type', type: 'text', value: ev.type },
                { name: 'volunteersNeeded', label: 'Volunteers Needed', type: 'number', value: ev.volunteersNeeded },
                { name: 'status', label: 'Status', type: 'text', value: ev.status }
            ];
            showModal('Edit Event', fields);
        };

        function showModal(title, fields) {
            document.getElementById('modalTitle').innerText = title;
            const formFieldsDiv = document.getElementById('modalFormFields');
            formFieldsDiv.innerHTML = '';
            fields.forEach(f => {
                const fieldHtml = `
                    <div class="form-group">
                        <label for="${f.name}">${f.label}</label>
                        ${f.type === 'textarea' ? 
                            `<textarea id="${f.name}" name="${f.name}" required>${f.value || ''}</textarea>` : 
                            `<input type="${f.type}" id="${f.name}" name="${f.name}" value="${f.value || ''}" ${f.type === 'number' ? 'step="any"' : ''} required>`
                        }
                    </div>
                `;
                formFieldsDiv.innerHTML += fieldHtml;
            });
            document.getElementById('editModal').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('editModal').style.display = 'none';
        };

        window.saveModalData = function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            if (currentEditContext.type === 'stat') {
                appData.stats[currentEditContext.key] = parseFloat(data[currentEditContext.key]);
                updateStats();
                showToast('Stat updated');
            } else if (currentEditContext.type === 'metric') {
                appData.impactMetrics[currentEditContext.key] = parseFloat(data[currentEditContext.key]);
                updateImpactMetricsUI();
                showToast('Metric updated');
            } else if (currentEditContext.type === 'volunteerStat') {
                if (currentEditContext.key === 'volunteerValueDisplay') {
                    appData.volunteerStats.volunteerValue = parseFloat(data.volunteerValueDisplay);
                } else {
                    appData.volunteerStats[currentEditContext.key] = parseFloat(data[currentEditContext.key]);
                }
                updateVolunteerStatsUI();
                showToast('Volunteer stat updated');
            } else if (currentEditContext.type === 'impactCard') {
                const card = appData.impactCards[currentEditContext.id];
                if (card) {
                    card.title = data.title;
                    card.icon = data.icon;
                    // Update items
                    Object.keys(card.items).forEach(key => {
                        const formKey = `item_${key}`;
                        if (data[formKey] !== undefined) {
                            card.items[key] = parseFloat(data[formKey]);
                        }
                    });
                    updateImpactCardsUI();
                    showToast('Impact card updated');
                }
            } else if (currentEditContext.type === 'event') {
                const ev = appData.events.find(e => e.id === currentEditContext.id);
                if (ev) {
                    ev.title = data.title;
                    ev.description = data.description;
                    ev.date = data.date;
                    ev.type = data.type;
                    ev.volunteersNeeded = parseInt(data.volunteersNeeded);
                    ev.status = data.status;
                    updateEventsUI();
                    showToast('Event updated');
                }
            }

            saveAppData();
            closeModal();
        };

        // ==================== DELETE FUNCTIONS ====================
        window.deleteImpactCard = function(cardId) {
            if (confirm('Are you sure you want to delete this impact card?')) {
                delete appData.impactCards[cardId];
                updateImpactCardsUI();
                saveAppData();
                showToast('Card deleted');
            }
        };

        window.deleteEvent = function(eventId) {
            if (confirm('Delete this event?')) {
                appData.events = appData.events.filter(e => e.id !== eventId);
                updateEventsUI();
                saveAppData();
                showToast('Event deleted');
            }
        };

        // ==================== ADD NEW FUNCTIONS ====================
        window.addNewImpactCard = function() {
            const newId = 'card' + Date.now();
            appData.impactCards[newId] = {
                category: 'new',
                title: 'New Initiative',
                icon: 'üåü',
                items: { metric1: 0, metric2: 0 }
            };
            updateImpactCardsUI();
            saveAppData();
            editImpactCard(newId); // Open for editing immediately
        };

        document.getElementById('newEventBtn').addEventListener('click', function() {
            const newId = 'ev' + Date.now();
            appData.events.push({
                id: newId,
                date: 'Jan 1, 2025 ‚Ä¢ 00:00',
                title: 'New Event',
                description: 'Description',
                type: 'General',
                volunteersNeeded: 5,
                volunteersSigned: 0,
                status: 'Planned'
            });
            updateEventsUI();
            saveAppData();
            editEvent(newId);
        });

        document.getElementById('newProgramBtn').addEventListener('click', function() {
            window.openModule('csr-program-management');
        });

        // ==================== MODULE OPENING (Now opens detailed views) ====================
        window.openModule = function(moduleName) {
            // In a real system, this would navigate to a detailed page or open a detailed panel
            // For this demo, we show a modal with detailed data from that module
            let title = moduleName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let content = '';

            // Gather relevant data based on module
            if (moduleName === 'csr-program-management') {
                content = `<h3>Active Programs: ${appData.stats.activePrograms}</h3><p>Total Investment: ${formatCurrency(appData.stats.csrInvestment)}</p>`;
                content += '<ul>' + Object.values(appData.impactCards).map(c => `<li>${c.title}</li>`).join('') + '</ul>';
            } else if (moduleName === 'community-partnerships') {
                content = `<p>Partners: ${appData.impactMetrics.partners}</p>`;
            } else if (moduleName === 'volunteer-management') {
                content = `<p>Active Volunteers: ${appData.volunteerStats.activeVolunteers}<br>Total Hours: ${appData.volunteerStats.totalVolunteerHours}</p>`;
            } else if (moduleName === 'event-planning') {
                content = '<h3>Upcoming Events:</h3>' + appData.events.map(e => `<p>${e.title} - ${e.date}</p>`).join('');
            } else if (moduleName === 'impact-assessment') {
                content = `<p>Success Rate: ${appData.impactMetrics.successRate}%<br>Satisfaction: ${appData.impactMetrics.satisfaction}%</p>`;
            } else if (moduleName === 'grant-management') {
                content = '<p>Grant Management Module - Coming soon with full CRUD</p>';
            } else {
                content = `<p>Detailed view for ${title} would be shown here with full CRUD operations.</p>`;
            }

            showModal(title, [{ name: 'info', label: 'Information', type: 'textarea', value: content }]);
        };

        // ==================== CSV UPLOAD FUNCTIONALITY ====================
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        const csv = ev.target.result;
                        // Simple parse (would be more robust in production)
                        const lines = csv.split('\n');
                        if (lines.length > 1) {
                            // Assume format: name,value
                            lines.forEach(line => {
                                const parts = line.split(',');
                                if (parts.length >= 2) {
                                    const key = parts[0].trim();
                                    const val = parseFloat(parts[1]);
                                    if (!isNaN(val) && appData.volunteerStats.hasOwnProperty(key)) {
                                        appData.volunteerStats[key] = val;
                                    }
                                }
                            });
                            updateVolunteerStatsUI();
                            saveAppData();
                            showToast('Volunteer data imported from CSV');
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showToast('Please select a valid CSV file.', 'error');
                }
            }
        });

        // Drag and drop
        const csvContainer = document.getElementById('csvUploadContainer');
        csvContainer.addEventListener('dragover', (e) => { e.preventDefault(); csvContainer.classList.add('dragover'); });
        csvContainer.addEventListener('dragleave', () => csvContainer.classList.remove('dragover'));
        csvContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            csvContainer.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    // Reuse same logic
                    document.getElementById('csvFileInput').files = e.dataTransfer.files;
                    document.getElementById('csvFileInput').dispatchEvent(new Event('change'));
                } else {
                    showToast('Please drop a valid CSV file.', 'error');
                }
            }
        });

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        // ==================== VOLUNTEER FOR EVENT ====================
        window.volunteerForEvent = function(eventId) {
            const ev = appData.events.find(e => e.id === eventId);
            if (ev) {
                ev.volunteersSigned = (ev.volunteersSigned || 0) + 1;
                updateEventsUI();
                saveAppData();
                showToast(`You've volunteered for ${ev.title}!`);
            }
        };

        // ==================== CHART CUSTOMIZER ====================
        window.showChartCustomizer = function() {
            showModal('Customize Chart', [
                { name: 'chartType', label: 'Chart Type', type: 'text', value: 'Pie' },
                { name: 'dataSource', label: 'Data Source', type: 'text', value: 'Impact Metrics' }
            ]);
        };

        // ==================== REFRESH IMPACT METRICS (Simulate) ====================
        window.refreshImpactMetrics = function() {
            // Simulate fetching new data
            appData.impactMetrics.successRate = Math.floor(Math.random() * 10) + 85;
            appData.impactMetrics.partners = Math.floor(Math.random() * 10) + 40;
            updateImpactMetricsUI();
            saveAppData();
            showToast('Impact metrics refreshed');
        };

        // ==================== OTHER EXISTING FUNCTIONALITY ====================
        // Mobile nav
        document.getElementById('mobileNavToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Dark mode
        document.getElementById('darkModeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const icon = this.querySelector('i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
        });

        // Language
        document.getElementById('languageSelect').addEventListener('change', function(e) {
            const lang = e.target.value;
            showToast(`Language changed to ${lang === 'en' ? 'English' : 'Swahili'} (simulated)`);
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Logout?')) showToast('Logged out (simulated)');
        });

        // Close modal if clicked outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) closeModal();
        };

        // PWA service worker registration (keep existing)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed: ', err));
            });
        }

        // Initialize
        updateAllUI();
    </script>
</body>
</html>

