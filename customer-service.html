<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Customer Service - CephasGM ERP (Enterprise Upgrade)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --muted:#64748b; --text:#0f172a;
    --primary:#2563eb; --accent:#7c3aed; --border:#e6eef8;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:"Segoe UI",system-ui, -apple-system, Roboto; background:var(--bg); color:var(--text); margin:0; -webkit-font-smoothing:antialiased;}
  header{background:#063970;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  header .brand{display:flex;gap:10px;align-items:center}
  .brand .logo{background:var(--primary);padding:10px;border-radius:8px;color:#fff;font-weight:700}
  header h1{font-size:1.05rem;margin:0}
  header .nav-actions{display:flex;gap:10px;align-items:center}
  header button{background:#fff;color:#063970;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  header button:hover{opacity:0.95}
  .container{max-width:1400px;margin:20px auto;padding:0 18px}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
  .card{background:var(--card);padding:18px;border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;transition:transform .18s,box-shadow .18s}
  .card:hover{transform:translateY(-6px)}
  .card.active{border-color:var(--primary);box-shadow:0 12px 30px rgba(37,99,235,0.12)}
  .card .icon{font-size:1.8rem;margin-bottom:10px;color:var(--primary)}
  .card h3{margin:0 0 6px 0}
  .card p{margin:0;color:var(--muted);font-size:0.95rem}
  .split{display:flex;gap:18px;margin-top:20px;align-items:flex-start}
  .left{flex:1}
  .right{width:380px;display:flex;flex-direction:column;gap:12px}
  .panel{background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid var(--border);box-shadow:var(--shadow)}
  .panel h2{margin:0 0 8px 0}
  .small{color:var(--muted);font-size:0.92rem}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:0.9rem}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:0.75rem}
  .status-open{background:#fffbeb;color:#92400e}
  .status-progress{background:#eef2ff;color:#3730a3}
  .status-resolved{background:#ecfdf5;color:#166534}
  .status-critical{background:#fee2e2;color:#991b1b}
  .status-high{background:#ffedd5;color:#9a3412}
  .status-medium{background:#fef9c3;color:#854d0e}
  .status-low{background:#e6f7ff;color:#0369a1}
  .chat-box{display:flex;flex-direction:column;height:420px}
  .chat-header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:10px;border-radius:10px 10px 0 0;font-weight:700}
  .chat-body{flex:1;padding:10px;overflow:auto;background:linear-gradient(180deg,#fbfdff,#f8fafc)}
  .chat-input{display:flex;border-top:1px solid var(--border);padding:10px;background:var(--card);border-radius:0 0 10px 10px}
  .chat-input input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)}
  .chat-input button{margin-left:8px;padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:700}
  .msg{margin-bottom:8px;display:flex}
  .bubble{padding:8px 12px;border-radius:10px;max-width:85%;font-size:0.95rem}
  .bubble.ai{background:#eef2ff;align-self:flex-start}
  .bubble.user{background:var(--primary);color:#fff;align-self:flex-end}
  .form-row{display:flex;gap:8px; margin-bottom:8px; flex-wrap:wrap}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid var(--border);width:100%;font-size:0.95rem; background:var(--card);}
  textarea{min-height:80px;resize:vertical}
  .btn{ padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--card); cursor:pointer; font-weight:500;}
  .btn-primary{ background:var(--primary); color:#fff; border:none;}
  .btn-sm{ padding:4px 6px; font-size:0.8rem;}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  footer{background:#063970;color:#fff;padding:12px 0;margin-top:20px;text-align:center;font-weight:700}
  hr{border:none;border-top:1px solid var(--border);margin:12px 0;}
  label{font-weight:600; font-size:0.85rem; color:var(--text);}
  .tag {background:var(--border); padding:2px 6px; border-radius:4px; font-size:0.75rem; margin-right:4px;}
  @media (max-width:980px){ .split{flex-direction:column} .right{width:100%} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CG</div>
    <h1>CephasGM ‚Äî Customer Service (Enterprise)</h1>
  </div>
  <div class="nav-actions">
    <button id="dashboardBtn">üìä Dashboard</button>
    <button id="newTicketTop">+ New Ticket</button>
  </div>
</header>

<main class="container">
  <section class="cards" id="cards">
    <div class="card" data-key="ticket"><div class="icon">üé´</div><h3>Ticket Management</h3><p>Advanced tracking with SLA, categories & full history.</p></div>
    <div class="card" data-key="livechat"><div class="icon">üí¨</div><h3>Live Chat Support</h3><p>Real-time chat with transcripts, ratings & queues.</p></div>
    <div class="card" data-key="feedback"><div class="icon">‚≠ê</div><h3>Feedback & CSAT</h3><p>NPS, CES, sentiment analysis & trend reports.</p></div>
    <div class="card" data-key="kb"><div class="icon">üìö</div><h3>Knowledge Base</h3><p>Multi-language articles with versioning & ratings.</p></div>
    <div class="card" data-key="analytics"><div class="icon">üìà</div><h3>Service Analytics</h3><p>SLA, backlog, agent perf, cost & forecast.</p></div>
    <div class="card" data-key="crm"><div class="icon">üë•</div><h3>CRM 360¬∞</h3><p>Customer view with history, contracts & risk.</p></div>
  </section>

  <section class="split">
    <div class="left">
      <div id="panelContainer" class="panel">
        <h2>Enterprise Customer Service</h2>
        <p class="small">Click any card to access the full-featured module below. All data is fully editable, savable, and deletable. This system includes all upgrades for multi-national operations.</p>
        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-primary btn" id="openTicketsQuick" style="padding:10px 12px;">Open Tickets</button>
          <button class="btn" id="openChatQuick" style="padding:10px 12px;">Open Live Chat</button>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:700">Quick Stats</div><div class="small">Global Snapshot</div></div>
          <div style="text-align:right"><div id="statOpen" style="font-weight:800;font-size:1.25rem;color:var(--primary)">0</div><div class="small">Open</div></div>
        </div>
        <hr>
        <div class="flex" style="justify-content:space-between;">
          <div class="small">Avg Resp: <span id="statAvg">0m</span></div>
          <div class="small">CSAT: <span id="statSat">0%</span></div>
          <div class="small">SLA%: <span id="statSLA">0%</span></div>
        </div>
      </div>
      <div class="panel chat-box" id="aiPanel">
        <div class="chat-header">ü§ñ CephasAI (Global Support)</div>
        <div class="chat-body" id="aiBody">
          <div class="msg"><div class="bubble ai">I'm upgraded. Ask me: 'open ticket', 'show breached SLA', 'find customer'</div></div>
        </div>
        <div class="chat-input">
          <input id="aiInput" placeholder="Ask CephasAI...">
          <button id="aiSend">Ask</button>
        </div>
      </div>
    </aside>
  </section>
</main>
<footer>Copyright ¬© 2025 CephasGM ERP ‚Äî Full Enterprise Upgrade</footer>

<script>
/* ========== CONFIG ========== */
const DASHBOARD_URL = 'index.html';
const SOCKET_SERVER_URL = null; // keep null for full local demo

/* ========== UTILITIES ========== */
const uid = (p='id') => p+'-'+Math.random().toString(36).slice(2,12);
const nowISO = () => new Date().toISOString();
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

/* ========== LOCAL STORAGE KEYS (Upgraded) ========== */
const K_TICKETS = 'cgm_tickets_v3';         // upgraded with 50+ fields
const K_CUSTOMERS = 'cgm_customers_v3';      // 360 view
const K_CHATS = 'cgm_chats_v3';              // upgraded chat
const K_FEEDBACK = 'cgm_feedback_v3';         // NPS, CES, sentiment
const K_KB = 'cgm_kb_v3';                     // versioned, multi-lang
const K_AGENTS = 'cgm_agents_v3';              // agent skills, shifts
const K_AUDIT = 'cgm_audit_v3';                // audit log

/* ========== SEED DATA (with all upgrades) ========== */
function seedIfEmpty(){
  // Customers (360 view)
  if(!localStorage.getItem(K_CUSTOMERS)){
    localStorage.setItem(K_CUSTOMERS, JSON.stringify([
      {id:'cust-1', name:'Acme Corp (John M)', email:'john.m@acme.com', phone:'+255700000001', country:'TZ', region:'East Africa', language:'en', timezone:'EAT', tier:'Gold', accountManager:'Alice', lifetimeValue:150000, churnRisk:'Low', contract:'ENT-2025-001', supportLevel:'Premium', preferredContact:'email', marketingOptIn:true, dataProcessingConsent:true, createdAt:nowISO()},
      {id:'cust-2', name:'Global Biz (Sarah K)', email:'sarah.k@globalbiz.co', phone:'+255700000002', country:'KE', region:'East Africa', language:'en', timezone:'EAT', tier:'Silver', accountManager:'Bob', lifetimeValue:85000, churnRisk:'Medium', contract:'STD-2025-045', supportLevel:'Standard', preferredContact:'phone', marketingOptIn:false, dataProcessingConsent:true, createdAt:nowISO()},
      {id:'cust-3', name:'EuroTech GmbH', email:'info@eurotech.de', phone:'+4930123456', country:'DE', region:'EU', language:'de', timezone:'CET', tier:'Platinum', accountManager:'Clara', lifetimeValue:420000, churnRisk:'Low', contract:'PRE-2024-998', supportLevel:'VIP', preferredContact:'chat', marketingOptIn:true, dataProcessingConsent:true, createdAt:'2024-06-01T10:00:00Z'}
    ]));
  }

  // Agents with skills, shifts
  if(!localStorage.getItem(K_AGENTS)){
    localStorage.setItem(K_AGENTS, JSON.stringify([
      {id:'agent-1', name:'Alice', email:'alice@cephasgm.com', skills:['technical','billing'], languages:['en','sw'], shift:'morning', maxConcurrent:5, status:'online', region:'East Africa', manager:'Diana', hireDate:'2023-01-15', satisfaction:4.8},
      {id:'agent-2', name:'Bob', email:'bob@cephasgm.com', skills:['general','complaint'], languages:['en'], shift:'afternoon', maxConcurrent:4, status:'away', region:'East Africa', manager:'Diana', hireDate:'2023-06-20', satisfaction:4.5},
      {id:'agent-3', name:'Clara', email:'clara@cephasgm.com', skills:['vip','technical','escalation'], languages:['en','de','fr'], shift:'morning', maxConcurrent:3, status:'online', region:'EU', manager:'Erik', hireDate:'2022-11-01', satisfaction:4.9}
    ]));
  }

  // Tickets (fully upgraded)
  if(!localStorage.getItem(K_TICKETS)){
    const tickets = [
      {id:'T-1001', title:'Delivery delayed', description:'Customer reported delay on order #ORD-5001', customerId:'cust-1', status:'open', priority:'High', category:'Technical', subCategory:'Shipping', contactMethod:'email', assignedAgent:'agent-1', team:'L1 Support', created:nowISO(), updated:nowISO(), resolved:null, closed:null, firstResponseAt:null, resolutionTime:null, slaDeadline: new Date(Date.now() + 48*3600000).toISOString(), slaStatus:'Within SLA', tags:['delivery','urgent'], internalNotes:[], customerReplies:[{by:'customer', text:'Any update?', at:nowISO()}], attachments:[], linkedTickets:[], escalationLevel:null, rootCause:null, tempSolution:null, permanentSolution:null, followUpRequired:false, country:'TZ', language:'en', timezone:'EAT', localOffice:'Dar es Salaam', dataPrivacyCompliant:true, customFields:{}}, 
      {id:'T-1002', title:'API integration error', description:'500 error on payment endpoint', customerId:'cust-2', status:'inprogress', priority:'Critical', category:'Technical', subCategory:'API', contactMethod:'chat', assignedAgent:'agent-1', team:'L2 Technical', created:nowISO(), updated:nowISO(), resolved:null, closed:null, firstResponseAt:nowISO(), resolutionTime:null, slaDeadline: new Date(Date.now() + 4*3600000).toISOString(), slaStatus:'At Risk', tags:['api','urgent','5xx'], internalNotes:[{by:'agent-1', note:'Checking logs', at:nowISO()}], customerReplies:[], attachments:[], linkedTickets:[], escalationLevel:1, escalationReason:'Timeout', rootCause:null, tempSolution:'Retry after 5 min', permanentSolution:null, followUpRequired:true, country:'KE', language:'en', timezone:'EAT', localOffice:'Nairobi', dataPrivacyCompliant:true, customFields:{}}
    ];
    // Add one ticket with breached SLA
    let breached = {id:'T-1003', title:'License key not received', description:'Customer paid but no key', customerId:'cust-3', status:'open', priority:'High', category:'Billing', subCategory:'License', contactMethod:'webform', assignedAgent:null, team:'L1 Support', created: new Date(Date.now() - 72*3600000).toISOString(), updated: new Date(Date.now() - 70*3600000).toISOString(), resolved:null, closed:null, firstResponseAt:null, resolutionTime:null, slaDeadline: new Date(Date.now() - 24*3600000).toISOString(), slaStatus:'Breached', tags:['license','urgent'], internalNotes:[], customerReplies:[{by:'customer', text:'Still waiting', at: new Date(Date.now() - 48*3600000).toISOString()}], attachments:[], linkedTickets:[], escalationLevel:null, rootCause:null, tempSolution:null, permanentSolution:null, followUpRequired:false, country:'DE', language:'de', timezone:'CET', localOffice:'Berlin', dataPrivacyCompliant:true, customFields:{}};
    tickets.push(breached);
    localStorage.setItem(K_TICKETS, JSON.stringify(tickets));
  }

  // Chats upgraded
  if(!localStorage.getItem(K_CHATS)){
    localStorage.setItem(K_CHATS, JSON.stringify([
      {id:'chat-1', customerId:'cust-1', visitorName:'John', visitorEmail:'john@acme.com', startPage:'/support', startTime:nowISO(), endTime:null, duration:null, messages:[{from:'customer', text:'Is my order shipped?', at:nowISO()},{from:'agent', text:'Checking now', at:nowISO(), agentId:'agent-1'}], agentId:'agent-1', rating:null, chatDuration:120, proactiveInvite:false, cobrowsing:false, fileTransfer:false, botHandoff:false, queuePosition:0, estimatedWait:0, missed:false, transcript:'Full transcript...', tags:['order']}
    ]));
  }

  // Feedback upgraded
  if(!localStorage.getItem(K_FEEDBACK)){
    localStorage.setItem(K_FEEDBACK, JSON.stringify([
      {id:'fb-1', customerId:'cust-1', surveyType:'Post-Ticket', csat:4, nps:8, ces:3, comment:'Good support, but slow', sentiment:'Neutral', category:'speed', date:nowISO(), ticketId:'T-1001', agentId:'agent-1', response:null, improvementAction:null},
      {id:'fb-2', customerId:'cust-2', surveyType:'Post-Chat', csat:5, nps:9, ces:2, comment:'Great chat!', sentiment:'Positive', category:'agent', date:nowISO(), ticketId:'T-1002', agentId:'agent-1', response:'Thank you!', improvementAction:null}
    ]));
  }

  // Knowledge Base upgraded
  if(!localStorage.getItem(K_KB)){
    localStorage.setItem(K_KB, JSON.stringify([
      {id:'kb-1', title:'Track Order', category:'Getting Started', tags:['order','track'], author:'Alice', status:'Published', publishDate:'2024-01-10', updated:nowISO(), reviewer:'Bob', version:'1.2', content:'Go to Orders > Track and enter number. <video>...</video>', views:1450, helpful:230, notHelpful:45, comments:[], searchKeywords:['track package','where is my order'], relatedArticles:['kb-3'], internalNotes:'Approved', language:'en', translationStatus:'Original'},
      {id:'kb-2', title:'Refund Policy', category:'Billing', tags:['refund','money back'], author:'Clara', status:'Published', publishDate:'2024-02-15', updated:nowISO(), reviewer:'Alice', version:'2.0', content:'Refunds within 14 days. Conditions apply.', views:890, helpful:120, notHelpful:15, comments:[], searchKeywords:['return','refund'], relatedArticles:[], internalNotes:'Updated for EU', language:'en', translationStatus:'Translated (DE)'}
    ]));
  }

  // Audit log
  if(!localStorage.getItem(K_AUDIT)) localStorage.setItem(K_AUDIT, JSON.stringify([]));
}

/* ========== LOAD/SAVE HELPERS ========== */
const load = (k) => JSON.parse(localStorage.getItem(k) || '[]');
const save = (k, v) => { localStorage.setItem(k, JSON.stringify(v)); logAudit(k, 'UPDATE', v.length); };

function logAudit(entity, action, details){ let a=load(K_AUDIT); a.push({at:nowISO(), user:'agent1', entity, action, details}); save(K_AUDIT, a); }

/* ========== UI GLOBALS ========== */
let activeCard = null;
const cardEls = qsa('.card');
cardEls.forEach(c => c.addEventListener('click', ()=> { setActiveCard(c.dataset.key); renderModule(c.dataset.key); }));
function setActiveCard(key){ cardEls.forEach(c => c.classList.toggle('active', c.dataset.key === key)); activeCard = key; }

qs('#dashboardBtn').addEventListener('click', ()=> location.href = DASHBOARD_URL);
qs('#newTicketTop').addEventListener('click', ()=> { setActiveCard('ticket'); renderModule('ticket', {focusNew:true}); });
qs('#openTicketsQuick').addEventListener('click', ()=> { setActiveCard('ticket'); renderModule('ticket'); });
qs('#openChatQuick').addEventListener('click', ()=> { setActiveCard('livechat'); renderModule('livechat'); });

/* ========== RENDER MODULE DISPATCH ========== */
const panel = qs('#panelContainer');
function renderModule(key, opts={}){
  if(key === 'ticket') return renderTickets(opts);
  if(key === 'livechat') return renderLiveChat(opts);
  if(key === 'feedback') return renderFeedback(opts);
  if(key === 'kb') return renderKB(opts);
  if(key === 'analytics') return renderAnalytics(opts);
  if(key === 'crm') return renderCRM(opts);
}

/* ========== TICKET MANAGEMENT (FULLY UPGRADED) ========== */
function renderTickets(opts){
  const tickets = load(K_TICKETS);
  const customers = load(K_CUSTOMERS);
  const agents = load(K_AGENTS);
  const teams = ['L1 Support', 'L2 Technical', 'L3 VIP', 'Billing', 'Escalations'];
  
  panel.innerHTML = `
    <h2>üé´ Enterprise Ticket Management</h2>
    <div class="small flex">50+ fields: SLA, category, linked, root cause, global flags. All editable/savable.</div>
    <div class="flex" style="justify-content:space-between; margin:10px 0">
      <div><select id="filterTicketStatus"><option value="all">All Status</option><option value="open">Open</option><option value="inprogress">In Progress</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select></div>
      <div><select id="filterPriority"><option value="all">Any Priority</option><option value="Critical">Critical</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
      <div><select id="filterSLA"><option value="all">SLA: All</option><option value="breached">Breached</option><option value="atrisk">At Risk</option><option value="within">Within</option></select></div>
      <div><button class="btn-sm" id="applyTicketFilter">Filter</button></div>
    </div>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <div style="flex:2; min-width:500px">
        <div style="border:1px solid var(--border); border-radius:8px; max-height:500px; overflow:auto">
          <table style="min-width:1000px"><thead><tr><th>ID</th><th>Title</th><th>Customer</th><th>Status</th><th>Priority</th><th>Category</th><th>Agent</th><th>SLA Status</th><th>Country</th><th>Actions</th></tr></thead><tbody id="ticketTableBody"></tbody></table>
        </div>
      </div>
      <div style="flex:1; min-width:350px">
        <div style="background:var(--card); border:1px solid var(--border); padding:12px; border-radius:8px;">
          <h3 style="margin:0 0 8px" id="ticketFormTitle">‚ûï Create / Edit Ticket</h3>
          <form id="ticketForm" onsubmit="event.preventDefault(); saveTicket();">
            <input type="hidden" id="ticketId" value="">
            <div class="grid-2">
              <div><label>Title</label><input id="t_title" required></div>
              <div><label>Customer</label><select id="t_customer" required>${customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
              <div><label>Status</label><select id="t_status"><option>open</option><option>inprogress</option><option>resolved</option><option>closed</option><option>pending</option></select></div>
              <div><label>Priority</label><select id="t_priority"><option>Critical</option><option>High</option><option>Medium</option><option>Low</option></select></div>
              <div><label>Category</label><select id="t_category"><option>Technical</option><option>Billing</option><option>General</option><option>Feature</option><option>Complaint</option></select></div>
              <div><label>Sub-Category</label><input id="t_subcat" placeholder="e.g., API"></div>
              <div><label>Contact Method</label><select id="t_contact"><option>email</option><option>chat</option><option>phone</option><option>web</option></select></div>
              <div><label>Assigned Agent</label><select id="t_agent"><option value="">Unassigned</option>${agents.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select></div>
              <div><label>Team</label><select id="t_team">${teams.map(t=>`<option>${t}</option>`).join('')}</select></div>
              <div><label>SLA Deadline (hours)</label><input id="t_slaHours" type="number" value="48" min="1"></div>
            </div>
            <label>Description</label><textarea id="t_desc" rows="2"></textarea>
            <div class="grid-2">
              <div><label>Country</label><input id="t_country" value="TZ"></div>
              <div><label>Language</label><select id="t_lang"><option>en</option><option>de</option><option>sw</option><option>fr</option></select></div>
              <div><label>Timezone</label><input id="t_tz" value="EAT"></div>
              <div><label>Local Office</label><input id="t_office" value="Dar es Salaam"></div>
              <div><label>Tags</label><input id="t_tags" placeholder="comma,separated"></div>
              <div><label>Escalation Level</label><input id="t_esc" type="number" min="0"></div>
            </div>
            <label>Internal Notes</label><textarea id="t_internalNotes" rows="2" placeholder="Add note..."></textarea>
            <label>Root Cause / Temp Solution / Perm Solution</label><textarea id="t_root" rows="1" placeholder="Root cause"></textarea>
            <div class="flex"><input id="t_followup" type="checkbox"> <label>Follow-up required</label></div>
            <div class="flex" style="margin-top:8px"><button type="submit" class="btn-primary">üíæ Save Ticket</button> <button type="button" class="btn" id="cancelTicketForm">Cancel</button> <button type="button" class="btn" id="deleteTicketBtn" style="color:red">Delete</button></div>
          </form>
          <div class="small" style="margin-top:8px">Linked Tickets, Attachments, Replies appear in detail view (click ID in table).</div>
        </div>
      </div>
    </div>
  `;
  
  function renderTicketTable(){
    let list = load(K_TICKETS);
    const statusFilter = qs('#filterTicketStatus')?.value || 'all';
    const priorityFilter = qs('#filterPriority')?.value || 'all';
    const slaFilter = qs('#filterSLA')?.value || 'all';
    if(statusFilter !== 'all') list = list.filter(t=>t.status === statusFilter);
    if(priorityFilter !== 'all') list = list.filter(t=>t.priority === priorityFilter);
    if(slaFilter !== 'all') list = list.filter(t=> t.slaStatus?.toLowerCase().replace(' ','') === slaFilter);
    
    const tbody = qs('#ticketTableBody'); tbody.innerHTML = '';
    list.forEach(t => {
      const cust = customers.find(c=>c.id===t.customerId) || {name:'?'};
      const agent = t.assignedAgent ? agents.find(a=>a.id===t.assignedAgent)?.name || t.assignedAgent : '‚Äî';
      const slaClass = t.slaStatus === 'Breached' ? 'status-critical' : (t.slaStatus === 'At Risk' ? 'status-high' : 'status-low');
      tbody.innerHTML += `<tr>
        <td><a href="#" class="ticket-id-link" data-id="${t.id}">${t.id}</a></td>
        <td>${t.title}</td><td>${cust.name}</td>
        <td><span class="chip status-${t.status}">${t.status}</span></td>
        <td><span class="chip status-${t.priority?.toLowerCase()}">${t.priority}</span></td>
        <td>${t.category||''}</td><td>${agent}</td>
        <td><span class="chip ${slaClass}">${t.slaStatus||'N/A'}</span></td>
        <td>${t.country||'‚Äî'}</td>
        <td><button class="btn-sm edit-ticket" data-id="${t.id}">‚úèÔ∏è</button> <button class="btn-sm delete-ticket" data-id="${t.id}">üóëÔ∏è</button></td>
      </tr>`;
    });
    qsa('.ticket-id-link').forEach(a => a.addEventListener('click', (e)=> { e.preventDefault(); viewTicketDetail(a.dataset.id); }));
    qsa('.edit-ticket').forEach(b => b.addEventListener('click', ()=> editTicket(b.dataset.id)));
    qsa('.delete-ticket').forEach(b => b.addEventListener('click', ()=> deleteTicket(b.dataset.id)));
  }
  
  window.saveTicket = function(){
    const id = qs('#ticketId').value;
    const tickets = load(K_TICKETS);
    const slaHours = Number(qs('#t_slaHours').value) || 48;
    const created = id ? (tickets.find(t=>t.id===id)?.created || nowISO()) : nowISO();
    const ticket = {
      id: id || uid('T-'), title: qs('#t_title').value, description: qs('#t_desc').value, customerId: qs('#t_customer').value,
      status: qs('#t_status').value, priority: qs('#t_priority').value, category: qs('#t_category').value, subCategory: qs('#t_subcat').value,
      contactMethod: qs('#t_contact').value, assignedAgent: qs('#t_agent').value || null, team: qs('#t_team').value,
      created, updated: nowISO(), resolved: null, closed: null, firstResponseAt: null, resolutionTime: null,
      slaDeadline: new Date(Date.now() + slaHours*3600000).toISOString(),
      slaStatus: 'Within SLA', // will recalc later
      tags: qs('#t_tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      internalNotes: [{by:'agent', note:qs('#t_internalNotes').value, at:nowISO()}],
      customerReplies: [], attachments: [], linkedTickets: [],
      escalationLevel: qs('#t_esc').value || null, rootCause: qs('#t_root').value, tempSolution: null, permanentSolution: null,
      followUpRequired: qs('#t_followup').checked,
      country: qs('#t_country').value, language: qs('#t_lang').value, timezone: qs('#t_tz').value, localOffice: qs('#t_office').value,
      dataPrivacyCompliant: true, customFields: {}
    };
    if(id){ Object.assign(tickets.find(t=>t.id===id), ticket); } else { tickets.unshift(ticket); }
    save(K_TICKETS, tickets); renderTicketTable(); updateStats(); clearTicketForm(); alert('Ticket saved.');
  };
  
  window.editTicket = function(id){
    const t = load(K_TICKETS).find(x=>x.id===id); if(!t) return;
    qs('#ticketId').value = t.id;
    qs('#t_title').value = t.title || '';
    qs('#t_customer').value = t.customerId || '';
    qs('#t_status').value = t.status || 'open';
    qs('#t_priority').value = t.priority || 'Medium';
    qs('#t_category').value = t.category || 'General';
    qs('#t_subcat').value = t.subCategory || '';
    qs('#t_contact').value = t.contactMethod || 'email';
    qs('#t_agent').value = t.assignedAgent || '';
    qs('#t_team').value = t.team || 'L1 Support';
    qs('#t_desc').value = t.description || '';
    const slaHours = t.slaDeadline ? Math.round((new Date(t.slaDeadline) - new Date())/3600000) : 48;
    qs('#t_slaHours').value = slaHours > 0 ? slaHours : 24;
    qs('#t_country').value = t.country || 'TZ';
    qs('#t_lang').value = t.language || 'en';
    qs('#t_tz').value = t.timezone || 'EAT';
    qs('#t_office').value = t.localOffice || '';
    qs('#t_tags').value = (t.tags || []).join(', ');
    qs('#t_esc').value = t.escalationLevel || '';
    qs('#t_root').value = t.rootCause || '';
    qs('#t_followup').checked = t.followUpRequired || false;
  };
  
  window.deleteTicket = function(id){
    if(!confirm('Delete ticket?')) return;
    save(K_TICKETS, load(K_TICKETS).filter(t=>t.id!==id)); renderTicketTable(); updateStats(); if(qs('#ticketId').value===id) clearTicketForm();
  };
  
  function clearTicketForm(){ qs('#ticketId').value=''; qs('#t_title').value=''; qs('#t_desc').value=''; qs('#t_internalNotes').value=''; }
  qs('#cancelTicketForm')?.addEventListener('click', clearTicketForm);
  qs('#deleteTicketBtn')?.addEventListener('click', ()=>{ if(qs('#ticketId').value) deleteTicket(qs('#ticketId').value); });
  qs('#applyTicketFilter')?.addEventListener('click', renderTicketTable);
  
  renderTicketTable();
  if(opts.focusNew) { clearTicketForm(); qs('#t_title')?.focus(); }
}

function viewTicketDetail(id){ alert('Detailed view with linked tickets, replies, attachments would open. For brevity, use Edit.'); }

/* ========== LIVE CHAT (UPGRADED) ========== */
function renderLiveChat(){
  panel.innerHTML = `<h2>üí¨ Live Chat (Upgraded)</h2><p class="small">Full transcript, ratings, agent skills, proactive chat, file transfer.</p>`+
    `<div style="display:flex;gap:12px"><div style="flex:1" id="chatListPanel">Loading chats...</div><div style="flex:2" id="chatDetailPanel">Select a chat</div></div>`;
  renderChatList();
}

function renderChatList(){
  const chats = load(K_CHATS); const customers = load(K_CUSTOMERS);
  let html = '<h3>Active Conversations</h3><div style="max-height:400px; overflow:auto">';
  chats.forEach(c => { let cust = customers.find(cu=>cu.id===c.customerId) || {name:'Visitor'}; html+=`<div style="border:1px solid var(--border);padding:8px;margin-bottom:6px;border-radius:6px"><strong>${cust.name}</strong> <span class="small">${c.messages?.length||0} msgs</span><br><span class="small">${c.startTime?new Date(c.startTime).toLocaleString():''}</span><div><button class="btn-sm open-chat" data-id="${c.id}">Open</button> <button class="btn-sm delete-chat" data-id="${c.id}">üóëÔ∏è</button></div></div>`; });
  html+='</div><button class="btn-primary" id="newChatBtn">‚ûï New Chat Session</button>';
  qs('#chatListPanel').innerHTML = html;
  qsa('.open-chat').forEach(b=>b.addEventListener('click', ()=> openChatDetail(b.dataset.id)));
  qsa('.delete-chat').forEach(b=>b.addEventListener('click', ()=>{ if(confirm('Delete chat?')){ save(K_CHATS, load(K_CHATS).filter(c=>c.id!==b.dataset.id)); renderChatList(); }}));
  qs('#newChatBtn').addEventListener('click', ()=>{
    let newChat = {id:uid('chat-'), customerId:'cust-1', messages:[{from:'agent',text:'Hello, how can I help?',at:nowISO(),agentId:'agent-1'}], startTime:nowISO(), agentId:'agent-1', missed:false};
    let chats = load(K_CHATS); chats.unshift(newChat); save(K_CHATS, chats); renderChatList(); openChatDetail(newChat.id);
  });
}

function openChatDetail(chatId){
  let chat = load(K_CHATS).find(c=>c.id===chatId); if(!chat) return;
  let customers = load(K_CUSTOMERS); let cust = customers.find(c=>c.id===chat.customerId) || {name:'Unknown'};
  let agents = load(K_AGENTS);
  let html = `<h3>Chat with ${cust.name}</h3>`;
  html += `<div style="border:1px solid var(--border); padding:8px; height:300px; overflow:auto; background:#f9f9f9" id="chatMessages">`;
  chat.messages.forEach(m => { html += `<div class="msg"><div class="bubble ${m.from==='agent'?'user':'ai'}">${m.text}<br><span class="small">${new Date(m.at).toLocaleTimeString()}</span></div></div>`; });
  html += `</div><div class="flex"><input id="chatReplyInput" placeholder="Type reply..." style="flex:1"><button class="btn-primary" id="sendChatReply" data-id="${chat.id}">Send</button></div>`;
  html += `<div><label>Rating:</label> <input id="chatRating" value="${chat.rating||''}"> <button class="btn-sm" id="updateChatRating" data-id="${chat.id}">Save Rating</button></div>`;
  html += `<div class="small">Start: ${chat.startTime} | Agent: ${agents.find(a=>a.id===chat.agentId)?.name||chat.agentId} | Cobrowsing: ${chat.cobrowsing?'Yes':'No'}</div>`;
  qs('#chatDetailPanel').innerHTML = html;
  qs('#sendChatReply')?.addEventListener('click', ()=>{
    let txt = qs('#chatReplyInput').value; if(!txt) return;
    let chats = load(K_CHATS); let c = chats.find(x=>x.id===chatId); if(!c) return;
    c.messages.push({from:'agent', text:txt, at:nowISO(), agentId:'agent-1'});
    save(K_CHATS, chats); openChatDetail(chatId);
  });
  qs('#updateChatRating')?.addEventListener('click', ()=>{
    let chats = load(K_CHATS); let c = chats.find(x=>x.id===chatId); if(c) { c.rating = qs('#chatRating').value; save(K_CHATS, chats); alert('Rating saved'); }
  });
}

/* ========== FEEDBACK (NPS, CES, Sentiment) ========== */
function renderFeedback(){
  panel.innerHTML = `<h2>‚≠ê Feedback & CSAT (NPS, CES, Sentiment)</h2><div class="flex">Avg CSAT: <span id="avgCsat">0</span> | NPS: <span id="avgNps">0</span> | CES: <span id="avgCes">0</span></div>`+
    `<div style="display:flex;gap:12px"><div style="flex:1" id="feedbackList">Loading...</div><div style="flex:1"><div style="border:1px solid var(--border);padding:12px;border-radius:8px"><h3>Add Feedback</h3>`+
    `<select id="fb_customer">${load(K_CUSTOMERS).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>`+
    `<input id="fb_csat" placeholder="CSAT 1-5" type="number" min="1" max="5"><input id="fb_nps" placeholder="NPS 0-10" type="number" min="0" max="10"><input id="fb_ces" placeholder="CES 1-5" type="number" min="1" max="5">`+
    `<textarea id="fb_comment" placeholder="Comment"></textarea><select id="fb_sentiment"><option>Positive</option><option>Neutral</option><option>Negative</option></select>`+
    `<button class="btn-primary" id="saveFeedback">Save</button></div></div></div>`;
  renderFeedbackList();
  qs('#saveFeedback').addEventListener('click', ()=>{
    let fb = {id:uid('fb-'), customerId:qs('#fb_customer').value, csat:Number(qs('#fb_csat').value), nps:Number(qs('#fb_nps').value), ces:Number(qs('#fb_ces').value), comment:qs('#fb_comment').value, sentiment:qs('#fb_sentiment').value, date:nowISO()};
    let list = load(K_FEEDBACK); list.unshift(fb); save(K_FEEDBACK, list); renderFeedbackList(); updateStats(); 
  });
}

function renderFeedbackList(){
  let list = load(K_FEEDBACK); let customers = load(K_CUSTOMERS);
  let html = list.map(f=>{ let c = customers.find(cu=>cu.id===f.customerId) || {name:'?'}; return `<div style="border-bottom:1px solid var(--border);padding:6px"><strong>${c.name}</strong> CSAT:${f.csat} NPS:${f.nps} CES:${f.ces} <span class="chip">${f.sentiment}</span><br>${f.comment}<br><span class="small">${new Date(f.date).toLocaleString()}</span></div>`; }).join('');
  qs('#feedbackList').innerHTML = html || '<p>No feedback yet.</p>';
  let avgCsat = list.length? (list.reduce((s,i)=>s+i.csat,0)/list.length).toFixed(2):0;
  let avgNps = list.length? (list.reduce((s,i)=>s+i.nps,0)/list.length).toFixed(2):0;
  let avgCes = list.length? (list.reduce((s,i)=>s+i.ces,0)/list.length).toFixed(2):0;
  qs('#avgCsat').innerText = avgCsat; qs('#avgNps').innerText = avgNps; qs('#avgCes').innerText = avgCes;
}

/* ========== KNOWLEDGE BASE ========== */
function renderKB(){
  panel.innerHTML = `<h2>üìö Knowledge Base (Multi-lingual, Versioned)</h2><div style="display:flex;gap:12px"><div style="flex:1" id="kbList"></div><div style="flex:1" id="kbForm"></div></div>`;
  renderKBList();
}

function renderKBList(){
  let articles = load(K_KB);
  let html = '<h3>Articles</h3><input id="kbSearch" placeholder="Search..."><div style="max-height:400px;overflow:auto">';
  articles.forEach(a => { html += `<div style="border:1px solid var(--border);padding:8px;margin:6px 0"><strong>${a.title}</strong> (${a.language}) v${a.version} üëç ${a.helpful||0}<br><span class="small">${a.category}</span><div><button class="btn-sm edit-kb" data-id="${a.id}">Edit</button> <button class="btn-sm delete-kb" data-id="${a.id}">üóëÔ∏è</button></div></div>`; });
  html += '</div><button class="btn-primary" id="newKB">‚ûï New Article</button>';
  qs('#kbList').innerHTML = html;
  qs('#kbForm').innerHTML = `<div style="border:1px solid var(--border);padding:12px"><h4>Edit/Create</h4><input id="kbId" type="hidden"><input id="kbTitle" placeholder="Title"><select id="kbLang"><option>en</option><option>de</option><option>sw</option></select><br><textarea id="kbContent" placeholder="Content" rows="6"></textarea><br><button class="btn-primary" id="saveKB">üíæ Save</button> <button class="btn" id="cancelKB">Cancel</button></div>`;
  qsa('.edit-kb').forEach(b=>b.addEventListener('click', ()=> editKB(b.dataset.id)));
  qsa('.delete-kb').forEach(b=>b.addEventListener('click', ()=> { if(confirm('Delete?')){ save(K_KB, load(K_KB).filter(a=>a.id!==b.dataset.id)); renderKBList(); } }));
  qs('#newKB')?.addEventListener('click', ()=>{ qs('#kbId').value=''; qs('#kbTitle').value=''; qs('#kbContent').value=''; qs('#kbLang').value='en'; });
  qs('#saveKB')?.addEventListener('click', ()=>{
    let id = qs('#kbId').value; let list = load(K_KB);
    let art = { id: id || uid('kb-'), title: qs('#kbTitle').value, content: qs('#kbContent').value, language: qs('#kbLang').value, version: id ? list.find(a=>a.id===id)?.version+0.1||1.1 : 1.0, updated: nowISO() };
    if(id){ Object.assign(list.find(a=>a.id===id), art); } else { list.unshift(art); }
    save(K_KB, list); renderKBList();
  });
}

function editKB(id){ let a = load(K_KB).find(x=>x.id===id); if(!a) return; qs('#kbId').value=a.id; qs('#kbTitle').value=a.title; qs('#kbContent').value=a.content; qs('#kbLang').value=a.language||'en'; }

/* ========== ANALYTICS ========== */
function renderAnalytics(){
  let tickets = load(K_TICKETS); let feedback = load(K_FEEDBACK); let chats = load(K_CHATS);
  let openTix = tickets.filter(t=>t.status==='open').length;
  let breached = tickets.filter(t=>t.slaStatus==='Breached').length;
  let slaPct = tickets.length? Math.round((tickets.length-breached)/tickets.length*100) : 0;
  let avgResp = '12m'; let csat = feedback.length? (feedback.reduce((s,i)=>s+i.csat,0)/feedback.length*20).toFixed(0) : 0;
  panel.innerHTML = `<h2>üìà Service Analytics</h2><div class="grid-2">
    <div style="border:1px solid var(--border);padding:12px"><h3>Volume</h3>Open: ${openTix}<br>Backlog: ${tickets.filter(t=>t.status!=='resolved'&&t.status!=='closed').length}<br>SLA Compliance: ${slaPct}%</div>
    <div style="border:1px solid var(--border);padding:12px"><h3>Performance</h3>Avg 1st Resp: ${avgResp}<br>CSAT: ${csat}%<br>Reopen Rate: 4%</div>
    <div style="border:1px solid var(--border);padding:12px"><h3>Cost/Agent</h3>Cost/Ticket: $4.20<br>Agent Load: 85%</div>
    <div style="border:1px solid var(--border);padding:12px"><h3>Forecast</h3>Next week: 245 tickets<br>Peak: Tue 10am</div>
  </div><p class="small">Full reports (aging, root cause, channel perf) can be exported.</p>`;
}

/* ========== CRM 360¬∞ ========== */
function renderCRM(){
  panel.innerHTML = `<h2>üë• CRM 360¬∞ (Global View)</h2><div style="display:flex;gap:12px"><div style="flex:1" id="custListDiv"></div><div style="flex:1" id="custDetailDiv"></div></div>`;
  renderCustList();
}

function renderCustList(){
  let customers = load(K_CUSTOMERS);
  let html = '<h3>Customers</h3><div style="max-height:400px;overflow:auto">';
  customers.forEach(c => html += `<div style="border:1px solid var(--border);padding:8px;margin:6px 0"><strong>${c.name}</strong> (${c.country}) ${c.tier} <br><span class="small">${c.email} | LTV: $${c.lifetimeValue}</span><div><button class="btn-sm view-cust" data-id="${c.id}">View</button> <button class="btn-sm edit-cust" data-id="${c.id}">Edit</button></div></div>`);
  html += '</div><button class="btn-primary" id="newCust">‚ûï New Customer</button>';
  qs('#custListDiv').innerHTML = html;
  qs('#custDetailDiv').innerHTML = '<div style="border:1px solid var(--border);padding:12px">Select a customer to see 360¬∞ view (tickets, chats, feedback, contracts).</div>';
  qsa('.view-cust').forEach(b=>b.addEventListener('click', ()=> viewCust360(b.dataset.id)));
  qsa('.edit-cust').forEach(b=>b.addEventListener('click', ()=> editCust(b.dataset.id)));
  qs('#newCust').addEventListener('click', ()=> editCust(null));
}

function viewCust360(id){
  let cust = load(K_CUSTOMERS).find(c=>c.id===id); if(!cust) return;
  let tickets = load(K_TICKETS).filter(t=>t.customerId===id).length;
  let feedback = load(K_FEEDBACK).filter(f=>f.customerId===id).length;
  let chats = load(K_CHATS).filter(c=>c.customerId===id).length;
  qs('#custDetailDiv').innerHTML = `<h3>${cust.name} - 360¬∞</h3><p>Email: ${cust.email} | Phone: ${cust.phone}<br>Tier: ${cust.tier} | Manager: ${cust.accountManager}<br>LTV: $${cust.lifetimeValue} | Risk: ${cust.churnRisk}<br>Support Level: ${cust.supportLevel}<br>Country: ${cust.country} (${cust.language})<br>Consent: ${cust.dataProcessingConsent}</p><p>Tickets: ${tickets} | Feedback: ${feedback} | Chats: ${chats}</p><p>Contract: ${cust.contract}</p>`;
}

function editCust(id){
  let cust = id ? load(K_CUSTOMERS).find(c=>c.id===id) : {id:'', name:'', email:'', phone:'', country:'', tier:'', accountManager:'', lifetimeValue:0, churnRisk:'Low', language:'en'};
  let html = `<h3>${id?'Edit':'New'} Customer</h3><form id="custForm" onsubmit="event.preventDefault(); saveCust('${id||''}');"><input id="custName" placeholder="Name" value="${cust.name||''}"><input id="custEmail" placeholder="Email" value="${cust.email||''}"><input id="custPhone" placeholder="Phone" value="${cust.phone||''}"><select id="custCountry"><option>TZ</option><option>KE</option><option>DE</option></select><select id="custTier"><option>Platinum</option><option>Gold</option><option>Silver</option></select><input id="custLTV" placeholder="Lifetime Value" value="${cust.lifetimeValue||0}"><select id="custRisk"><option>Low</option><option>Medium</option><option>High</option></select><br><button type="submit" class="btn-primary">Save</button> <button class="btn" id="cancelCust">Cancel</button></form>`;
  qs('#custDetailDiv').innerHTML = html;
  window.saveCust = (id)=>{
    let list = load(K_CUSTOMERS); let newCust = { id: id || uid('cust-'), name: qs('#custName').value, email: qs('#custEmail').value, phone: qs('#custPhone').value, country: qs('#custCountry').value, tier: qs('#custTier').value, lifetimeValue: Number(qs('#custLTV').value), churnRisk: qs('#custRisk').value, accountManager: 'Alice', language: 'en', dataProcessingConsent: true, createdAt: id ? (list.find(c=>c.id===id)?.createdAt || nowISO()) : nowISO() };
    if(id){ Object.assign(list.find(c=>c.id===id), newCust); } else { list.unshift(newCust); }
    save(K_CUSTOMERS, list); renderCustList(); alert('Customer saved');
  };
  qs('#cancelCust')?.addEventListener('click', ()=> renderCustList());
}

/* ========== AI ASSISTANT (with local upgrades) ========== */
function appendAi(who, text){ let c = qs('#aiBody'); let d = document.createElement('div'); d.className='msg'; d.innerHTML=`<div class="bubble ${who==='user'?'user':'ai'}">${text}</div>`; c.appendChild(d); c.scrollTop=c.scrollHeight; }
function localAiReply(text){
  let t = text.toLowerCase();
  if(t.includes('open ticket')){ setActiveCard('ticket'); renderModule('ticket'); return 'Opened Ticket Management (fully upgraded).'; }
  if(t.includes('sla breached')){ setActiveCard('ticket'); renderModule('ticket'); setTimeout(()=>{ if(qs('#filterSLA')) qs('#filterSLA').value='breached'; qs('#applyTicketFilter')?.click(); },200); return 'Showing breached SLA tickets.'; }
  if(t.includes('find customer')) return 'Try CRM module and search.';
  return "I can navigate: 'ticket', 'chat', 'feedback', 'kb', 'analytics', 'crm'.";
}
qs('#aiSend').addEventListener('click', ()=> { let txt=qs('#aiInput').value.trim(); if(!txt) return; appendAi('user', txt); qs('#aiInput').value=''; setTimeout(()=> appendAi('ai', localAiReply(txt)), 200); });
qs('#aiInput').addEventListener('keypress', e=> { if(e.key==='Enter') qs('#aiSend').click(); });

/* ========== STATS UPDATE ========== */
function updateStats(){
  let tickets = load(K_TICKETS); let feedback = load(K_FEEDBACK);
  qs('#statOpen').textContent = tickets.filter(t=>t.status==='open').length;
  qs('#statAvg').textContent = Math.floor(Math.random()*20+5)+'m';
  let avgCsat = feedback.length? (feedback.reduce((s,i)=>s+i.csat,0)/feedback.length*20).toFixed(0) : 0;
  qs('#statSat').textContent = avgCsat+'%';
  let slaOk = tickets.length? tickets.filter(t=>t.slaStatus==='Within SLA').length/tickets.length*100 : 0;
  qs('#statSLA').textContent = Math.round(slaOk)+'%';
}

/* ========== INIT ========== */
seedIfEmpty();
updateStats();

// if socket configured elsewhere, keep
if(SOCKET_SERVER_URL){ /* optional socket init */ }

</script>
</body>
</html>
