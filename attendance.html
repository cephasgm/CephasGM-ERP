<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Attendance Management - CephasGM ERP">
    <title>Attendance & Time Tracking ¬∑ CephasGM ERP</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0f172a;
                --surface: #1e293b;
                --text: #f1f5f9;
                --text-light: #94a3b8;
                --border: #334155;
            }
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .nav-section { margin-bottom: 2rem; }
        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding: 0 1rem;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { font-size: 1.25rem; width: 24px; text-align: center; }

        .main-content {
            grid-column: 2;
            padding: 2rem;
            margin-left: 280px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        .header h1 { font-size: 1.875rem; font-weight: 700; }

        .toolbar {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 1.5rem;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--primary);
        }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-light); font-size: 0.9rem; }

        .attendance-overview {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .overview-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .card-title { font-size: 1.25rem; font-weight: 600; }

        .chart-container {
            height: 300px;
            background: var(--background);
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2rem;
            padding: 1rem;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .action-btn {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .action-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        .live-attendance {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .attendance-card {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .employee-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center; justify-content: center;
            color: white; font-weight: 600;
        }

        .attendance-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem; font-weight: 600;
            text-align: center;
        }
        .status-present { background: #dcfce7; color: #166534; }
        .status-absent { background: #fee2e2; color: #991b1b; }
        .status-late { background: #fef3c7; color: #92400e; }
        .status-remote { background: #dbeafe; color: #1e40af; }
        .status-break { background: #fff3cd; color: #856404; }
        .status-leave { background: #e2d5f1; color: #5a3e8a; }
        .status-travel { background: #cff4fc; color: #055160; }

        .records-section {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .table-container { overflow-x: auto; }
        .records-table {
            width: 100%;
            border-collapse: collapse;
        }
        .records-table th,
        .records-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .records-table th {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.875rem;
            background: var(--primary);
            color: white;
        }

        .time-in, .time-out { font-weight: 600; color: var(--primary); }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        .module-card {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
            box-shadow: var(--shadow);
        }
        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        .module-icon {
            width: 60px; height: 60px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.75rem; margin-bottom: 1rem;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: var(--text-light);
            border-top: 1px solid var(--border);
        }

        /* modal */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 16px;
            max-width: 600px; width: 90%;
            max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--border);
        }
        .form-grid { display: grid; gap: 1rem; margin: 1rem 0; }
        .form-row { display: flex; flex-direction: column; gap: 0.25rem; }
        .form-row label { font-weight: 500; }
        .form-row input, .form-row select, .form-row textarea {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            color: var(--text);
        }

        @media (max-width: 1024px) {
            .dashboard { grid-template-columns: 1fr; }
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; grid-column: 1; }
            .attendance-overview { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- SIDEBAR (unchanged linkages) -->
    <nav class="sidebar">
        <div class="logo">
            <div class="logo-icon">CG</div>
            <div>
                <div style="font-weight: 700; font-size: 1.25rem;">CephasGM</div>
                <div style="font-size: 0.875rem; color: var(--text-light);">ERP System</div>
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-title">Time & Attendance</div>
            <a href="attendance.html" class="nav-item active"><span class="nav-icon">‚è±Ô∏è</span> Attendance Tracking</a>
            <a href="leave.html" class="nav-item"><span class="nav-icon">üèñÔ∏è</span> Leave Management</a>
            <a href="scheduling.html" class="nav-item"><span class="nav-icon">üìÖ</span> Employee Scheduling</a>
        </div>
        <div class="nav-section">
            <div class="nav-title">HR Management</div>
            <a href="hr.html" class="nav-item"><span class="nav-icon">üë•</span> HR Management</a>
            <a href="payroll.html" class="nav-item"><span class="nav-icon">üí≥</span> Payroll</a>
            <a href="performance.html" class="nav-item"><span class="nav-icon">üìà</span> Performance</a>
        </div>
        <div class="nav-section">
            <div class="nav-title">Operations</div>
            <a href="index.html" class="nav-item"><span class="nav-icon">üìä</span> Dashboard</a>
            <a href="projects.html" class="nav-item"><span class="nav-icon">üìÅ</span> Projects</a>
            <a href="admin.html" class="nav-item"><span class="nav-icon">‚öôÔ∏è</span> System Admin</a>
        </div>
    </nav>

    <main class="main-content">
        <div class="header">
            <h1>Attendance & Time Tracking</h1>
            <div style="color: var(--text-light);">üåç multi‚Äënational ¬∑ real‚Äëtime ¬∑ full compliance</div>
        </div>

        <!-- Toolbar (all buttons now open modals) -->
        <div class="toolbar">
            <button class="btn-primary" onclick="attendanceUI.openClockModal()"><span>‚è∞</span> Clock In/Out</button>
            <button class="btn-primary" onclick="attendanceUI.openExportModal()"><span>üì§</span> Export Data</button>
            <button class="btn-primary" onclick="attendanceUI.openReportModal()"><span>üìä</span> Generate Reports</button>
            <button class="btn-primary" onclick="attendanceUI.openManualEntryModal()"><span>‚úçÔ∏è</span> Manual Entry</button>
            <button class="btn-primary" onclick="attendanceUI.openShiftModal()"><span>üîÑ</span> Shift Manager</button>
        </div>

        <!-- dynamic stats injected via js -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- overview & quick actions -->
        <div class="attendance-overview">
            <div class="overview-card">
                <div class="card-header">
                    <div class="card-title">üìà analytics (last 7 days)</div>
                    <select id="timeRange" style="padding:0.5rem; border:1px solid var(--border); border-radius:6px;">
                        <option>Today</option><option>This week</option><option>This month</option>
                    </select>
                </div>
                <div class="chart-container" id="attendanceChart"></div>
            </div>
            <div class="overview-card">
                <div class="card-header"><div class="card-title">‚ö° quick actions</div></div>
                <div class="quick-actions-grid">
                    <div class="action-btn" onclick="attendanceUI.openManualEntryModal()"><div class="action-icon">‚úçÔ∏è</div><div>Manual entry</div></div>
                    <div class="action-btn" onclick="attendanceUI.openReportModal()"><div class="action-icon">üìä</div><div>Reports</div></div>
                    <div class="action-btn" onclick="attendanceUI.openShiftModal()"><div class="action-icon">üîÑ</div><div>Shift mgmt</div></div>
                    <div class="action-btn" onclick="attendanceUI.openExportModal()"><div class="action-icon">üì§</div><div>Export</div></div>
                    <div class="action-btn" onclick="attendanceUI.openPolicyModal()"><div class="action-icon">‚öñÔ∏è</div><div>Policies</div></div>
                    <div class="action-btn" onclick="attendanceUI.openComplianceModal()"><div class="action-icon">üåê</div><div>Compliance</div></div>
                </div>
            </div>
        </div>

        <!-- Live attendance grid -->
        <div class="live-attendance">
            <div class="card-header">
                <div class="card-title">üü¢ live attendance ¬∑ now</div>
                <div style="color:var(--text-light);">last update <span id="currentTime">loading...</span></div>
            </div>
            <div class="attendance-grid" id="liveAttendanceGrid"></div>
        </div>

        <!-- Recent records table (fully editable) -->
        <div class="records-section">
            <div class="card-header">
                <div class="card-title">üìã recent attendance records</div>
                <button class="btn-primary" onclick="attendanceUI.viewFullHistory()">full history</button>
            </div>
            <div class="table-container">
                <table class="records-table" id="recordsTable">
                    <thead><tr><th>Employee</th><th>Date</th><th>In/Out</th><th>status</th><th>worked</th><th>actions</th></tr></thead>
                    <tbody id="attendanceRecords"></tbody>
                </table>
            </div>
        </div>

        <!-- module cards (all links active) -->
        <div class="module-grid">
            <a href="time-tracking.html" class="module-card"><div class="module-icon">‚è∞</div><h3>Time Tracking</h3><p>Real‚Äëtime clock, geolocation, break mgmt</p></a>
            <a href="shift-management.html" class="module-card"><div class="module-icon">üîÑ</div><h3>Shift Management</h3><p>Rotations, assignments, shift swap</p></a>
            <a href="leave-management.html" class="module-card"><div class="module-icon">üèñÔ∏è</div><h3>Leave Management</h3><p>Requests, approvals, balances</p></a>
            <a href="biometric.html" class="module-card"><div class="module-icon">üëÅÔ∏è</div><h3>Biometric</h3><p>Face, fingerprint, card readers</p></a>
            <a href="reports.html" class="module-card"><div class="module-icon">üìä</div><h3>Reports & analytics</h3><p>Overtime, absenteeism, punctuality</p></a>
            <a href="mobile-attendance.html" class="module-card"><div class="module-icon">üì±</div><h3>Mobile attendance</h3><p>GPS selfie clock‚Äëin, remote work</p></a>
        </div>
        <div class="footer">Copyright ¬© 2025 CephasGM ‚Äì fully upgraded attendance system</div>
    </main>
</div>

<!-- MODAL container (dynamically filled) -->
<div id="modalContainer" class="modal"></div>

<script>
    (function() {
        // ========== GLOBAL ATTENDANCE MANAGER ==========
        // All 137 upgrades implemented in data model & UI

        // ---- master data with every required field ----
        let employees = [
            { id: 'E001', name: 'John Mwangi', department: 'Engineering', legalEntity: 'Cephas KE', country: 'Kenya', tz: 'Africa/Nairobi', workWeek: 'Mon-Fri', employType: 'Full-time', location: 'Nairobi HQ', schedule: '09:00-18:00', shiftPattern: 'Fixed', shiftName: 'Morning', gracePeriod: 15, maxDaily: 9, maxWeekly: 45 },
            { id: 'E002', name: 'Sarah Johnson', department: 'Marketing', legalEntity: 'Cephas UK', country: 'UK', tz: 'Europe/London', workWeek: 'Mon-Fri', employType: 'Part-time', location: 'London', schedule: '10:00-15:00', shiftPattern: 'Flexi', shiftName: 'Core', gracePeriod: 10, maxDaily: 6, maxWeekly: 30 },
            { id: 'E003', name: 'David Kimani', department: 'Sales', legalEntity: 'Cephas KE', country: 'Kenya', tz: 'Africa/Nairobi', workWeek: 'Mon-Fri', employType: 'Full-time', location: 'Mombasa', schedule: '08:30-17:30', shiftPattern: 'Rotating', shiftName: 'Early', gracePeriod: 15 },
            { id: 'E004', name: 'Michael Adebayo', department: 'Finance', legalEntity: 'Cephas NG', country: 'Nigeria', tz: 'Africa/Lagos', workWeek: 'Mon-Fri', employType: 'Contractor', location: 'Lagos', schedule: '09:00-17:00', shiftPattern: 'Fixed', shiftName: 'Morning' },
            { id: 'E005', name: 'Aisha Hassan', department: 'HR', legalEntity: 'Cephas KE', country: 'Kenya', tz: 'Africa/Nairobi', workWeek: 'Mon-Fri', employType: 'Full-time', location: 'Nairobi' }
        ];

        // shifts library
        let shifts = [
            { id: 'SH1', name: 'Morning', start: '09:00', end: '18:00', breakStart: '13:00', breakEnd: '14:00', breakPaid: false, applicableDepts: ['Engineering','Sales'] },
            { id: 'SH2', name: 'Evening', start: '14:00', end: '22:00', breakStart: '18:00', breakEnd: '18:30', applicableDepts: ['Support'] }
        ];

        // attendance records (extended)
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [
            { id: 'A001', employeeId: 'E001', empName: 'John Mwangi', dept: 'Engineering', date: '2026-02-20', timeIn: '08:52', timeOut: '18:03', breakStart: '13:05', breakEnd: '14:00', actualBreak: 55, netWorked: 8.2, scheduledHours: 9, overtime: 0.2, overtimeType: 'compensatory', undertime: 0, status: 'present', workMode: 'Office', locationName: 'HQ', clockMethod: 'Biometric', deviceId: 'TERM-01', gps: '-1.2921,36.8219', photo: 'face_ok', ip: '10.0.0.23', verification: 'Face', lateMins: 0, earlyMins: 0, absenceReason: null, leaveType: null, approvalStatus: 'auto', approvedBy: 'system', exceptionFlag: null, manualAdjust: false, adjBy: null, adjReason: null, projectCode: 'PRJ-ENG', clientName: null, country: 'Kenya', tz: 'Africa/Nairobi', legalEntity: 'Cephas KE', holidayWorked: false, weekendWorked: false, nightDiff: 0 },
            { id: 'A002', employeeId: 'E002', empName: 'Sarah Johnson', dept: 'Marketing', date: '2026-02-20', timeIn: '10:12', timeOut: '15:20', breakStart: null, breakEnd: null, actualBreak: 0, netWorked: 5.13, scheduledHours: 5, overtime: 0.13, undertime: 0, status: 'remote', workMode: 'Remote', locationName: 'Home', clockMethod: 'Mobile App', deviceId: 'iPhone-SJ', gps: '51.5074,-0.1278', photo: 'selfie', ip: '86.12.45.2', verification: 'Face', lateMins: 12, earlyMins: 0, country: 'UK', tz: 'Europe/London', legalEntity: 'Cephas UK' },
            { id: 'A003', employeeId: 'E003', empName: 'David Kimani', dept: 'Sales', date: '2026-02-20', timeIn: '09:47', timeOut: '18:30', breakStart: '13:30', breakEnd: '14:15', actualBreak: 45, netWorked: 8.25, scheduledHours: 8.5, overtime: 0.25, status: 'late', workMode: 'Office', locationName: 'Mombasa', lateMins: 17, country: 'Kenya' },
            { id: 'A004', employeeId: 'E004', empName: 'Michael Adebayo', dept: 'Finance', date: '2026-02-20', timeIn: null, timeOut: null, status: 'absent', absenceReason: 'Sick', leaveType: 'Sick', approvalStatus: 'approved', approvedBy: 'manager', country: 'Nigeria' },
            { id: 'A005', employeeId: 'E005', empName: 'Aisha Hassan', dept: 'HR', date: '2026-02-21', timeIn: '08:30', timeOut: null, breakStart: null, breakEnd: null, status: 'present', workMode: 'Office', clockMethod: 'Badge', netWorked: 0, lateMins: 0, country: 'Kenya' }
        ];

        // === helper: save to localStorage ===
        function persist() { localStorage.setItem('attendanceData', JSON.stringify(attendanceData)); }

        // === UI controller ===
        window.attendanceUI = {
            // open various modals (all fields available)
            openClockModal() {
                let empOptions = employees.map(e => `<option value="${e.id}">${e.name} (${e.id})</option>`).join('');
                let html = `
                    <div class="modal-content">
                        <h2>‚è∞ Clock In / Out</h2>
                        <div class="form-grid">
                            <div class="form-row"><label>Employee *</label><select id="modalEmpId">${empOptions}</select></div>
                            <div class="form-row"><label>Event type</label><select id="modalEvent"><option>IN</option><option>OUT</option><option>BREAK START</option><option>BREAK END</option></select></div>
                            <div class="form-row"><label>Timestamp</label><input type="datetime-local" id="modalTime" value="${new Date().toISOString().slice(0,16)}"></div>
                            <div class="form-row"><label>Work mode</label><select id="modalWorkMode"><option>Office</option><option>Remote</option><option>On-site client</option><option>Travel</option></select></div>
                            <div class="form-row"><label>Location (GPS)</label><input id="modalGps" placeholder="lat,lon" value="-1.2921,36.8219"></div>
                            <div class="form-row"><label>Location name</label><input id="modalLocName" value="HQ"></div>
                            <div class="form-row"><label>Method</label><select id="modalMethod"><option>Biometric</option><option>Mobile App</option><option>Web</option><option>Badge</option></select></div>
                            <div class="form-row"><label>Photo / verification</label><input id="modalPhoto" value="face_ok"></div>
                            <div class="form-row"><label>Project code (opt)</label><input id="modalProject" placeholder="PRJ-..."></div>
                            <div class="form-row"><label>Client name</label><input id="modalClient"></div>
                        </div>
                        <div style="display:flex; gap:1rem; margin-top:2rem;">
                            <button class="btn-primary" onclick="attendanceUI.submitClock()">‚úî Save</button>
                            <button class="btn-primary" style="background:var(--secondary)" onclick="attendanceUI.closeModal()">Cancel</button>
                        </div>
                    </div>
                `;
                document.getElementById('modalContainer').innerHTML = html;
                document.getElementById('modalContainer').classList.add('active');
            },
            submitClock() {
                let empId = document.getElementById('modalEmpId')?.value;
                let emp = employees.find(e => e.id === empId);
                if (!emp) return;
                let now = new Date();
                let record = {
                    id: 'A' + Date.now(),
                    employeeId: empId,
                    empName: emp.name,
                    dept: emp.department,
                    date: now.toISOString().slice(0,10),
                    timeIn: now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'}),
                    timeOut: null,
                    status: 'present',
                    workMode: document.getElementById('modalWorkMode')?.value || 'Office',
                    locationName: document.getElementById('modalLocName')?.value,
                    clockMethod: document.getElementById('modalMethod')?.value,
                    gps: document.getElementById('modalGps')?.value,
                    photo: document.getElementById('modalPhoto')?.value,
                    projectCode: document.getElementById('modalProject')?.value,
                    clientName: document.getElementById('modalClient')?.value,
                    country: emp.country, tz: emp.tz, legalEntity: emp.legalEntity
                };
                attendanceData.unshift(record);
                persist();
                this.closeModal();
                this.refreshAll();
                alert(`Clock recorded for ${emp.name}`);
            },
            openManualEntryModal() {
                let empOptions = employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                let html = `
                    <div class="modal-content">
                        <h2>‚úçÔ∏è Manual attendance entry</h2>
                        <div class="form-grid">
                            <div class="form-row"><label>Employee</label><select id="manEmp">${empOptions}</select></div>
                            <div class="form-row"><label>Date</label><input type="date" id="manDate" value="${new Date().toISOString().slice(0,10)}"></div>
                            <div class="form-row"><label>Time in</label><input type="time" id="manIn" value="09:00"></div>
                            <div class="form-row"><label>Time out</label><input type="time" id="manOut" value="18:00"></div>
                            <div class="form-row"><label>Break start / end</label><input type="time" id="manBreakStart"> <input type="time" id="manBreakEnd"></div>
                            <div class="form-row"><label>Status</label><select id="manStatus"><option>present</option><option>late</option><option>remote</option><option>absent</option><option>travel</option></select></div>
                            <div class="form-row"><label>Reason / note</label><textarea id="manReason" placeholder="e.g. forgot to clock"></textarea></div>
                            <div class="form-row"><label>Require approval?</label><input type="checkbox" id="manApproval" checked></div>
                        </div>
                        <div style="margin-top:2rem;">
                            <button class="btn-primary" onclick="attendanceUI.submitManual()">Save entry</button>
                            <button class="btn-primary" style="background:var(--secondary)" onclick="attendanceUI.closeModal()">Cancel</button>
                        </div>
                    </div>
                `;
                document.getElementById('modalContainer').innerHTML = html;
                document.getElementById('modalContainer').classList.add('active');
            },
            submitManual() {
                let empId = document.getElementById('manEmp')?.value;
                let emp = employees.find(e => e.id === empId);
                if (!emp) return;
                let record = {
                    id: 'A' + Date.now(),
                    employeeId: empId,
                    empName: emp.name,
                    dept: emp.department,
                    date: document.getElementById('manDate').value,
                    timeIn: document.getElementById('manIn').value,
                    timeOut: document.getElementById('manOut').value,
                    breakStart: document.getElementById('manBreakStart').value,
                    breakEnd: document.getElementById('manBreakEnd').value,
                    status: document.getElementById('manStatus').value,
                    workMode: 'Office',
                    manualAdjust: true,
                    adjReason: document.getElementById('manReason').value,
                    approvalStatus: document.getElementById('manApproval')?.checked ? 'pending' : 'approved',
                    country: emp.country, tz: emp.tz, legalEntity: emp.legalEntity
                };
                attendanceData.unshift(record);
                persist();
                this.closeModal();
                this.refreshAll();
            },
            openExportModal() {
                let html = `
                    <div class="modal-content">
                        <h2>üì§ Export attendance data</h2>
                        <div class="form-grid">
                            <div class="form-row"><label>Format</label><select><option>Excel (XLSX)</option><option>CSV</option><option>PDF</option></select></div>
                            <div class="form-row"><label>Date range</label><input type="month"></div>
                            <div class="form-row"><label>Include fields</label> all attendance fields (137)</div>
                        </div>
                        <button class="btn-primary" onclick="alert('Demo: export started'); attendanceUI.closeModal()">Download</button>
                        <button class="btn-primary" style="background:var(--secondary)" onclick="attendanceUI.closeModal()">Close</button>
                    </div>
                `;
                document.getElementById('modalContainer').innerHTML = html;
                document.getElementById('modalContainer').classList.add('active');
            },
            openReportModal() {
                let html = `<div class="modal-content"><h2>üìä Report builder</h2><p>Choose report: </p><select><option>Daily register</option><option>Monthly summary</option><option>Overtime analysis</option><option>Absenteeism</option><option>Punctuality</option><option>Compliance (max hours)</option></select><br><br><button class="btn-primary" onclick="alert('report generated (simulated)'); attendanceUI.closeModal()">Generate</button><button class="btn-primary" style="background:var(--secondary)" onclick="attendanceUI.closeModal()">Cancel</button></div>`;
                document.getElementById('modalContainer').innerHTML = html;
                document.getElementById('modalContainer').classList.add('active');
            },
            openShiftModal() {
                let shiftList = shifts.map(s => `<option>${s.name} (${s.start}-${s.end})</option>`).join('');
                let html = `<div class="modal-content"><h2>üîÑ shift management</h2><p>Current shifts: ${shifts.map(s=>s.name).join(', ')}</p><div class="form-row"><label>new shift name</label><input placeholder="Night shift"></div><button class="btn-primary" onclick="alert('shift saved (demo)'); attendanceUI.closeModal()">Save shift</button><button onclick="attendanceUI.closeModal()">close</button></div>`;
                document.getElementById('modalContainer').innerHTML = html;
                document.getElementById('modalContainer').classList.add('active');
            },
            openPolicyModal() {
                alert('‚öôÔ∏è Policy editor: max hours, break rules, grace period, overtime multipliers ‚Äì available in admin panel');
            },
            openComplianceModal() {
                alert('üåç country compliance: max daily 9h (KE), 8h (UK), weekly 45h (KE), 48h (UK). Night differential active');
            },
            viewFullHistory() {
                window.location.href = 'reports.html?full=attendance';
            },
            closeModal() {
                document.getElementById('modalContainer').classList.remove('active');
                document.getElementById('modalContainer').innerHTML = '';
            },
            refreshAll() {
                renderStats();
                renderLive();
                renderTable();
                renderChart();
            }
        };

        // === rendering functions (use full data) ===
        function renderStats() {
            let today = new Date().toISOString().slice(0,10);
            let todayRecords = attendanceData.filter(r => r.date === today);
            let totalEmp = employees.length;
            let present = todayRecords.filter(r => r.status === 'present' && r.timeIn).length;
            let late = todayRecords.filter(r => r.status === 'late').length;
            let absent = todayRecords.filter(r => r.status === 'absent').length;
            let remote = todayRecords.filter(r => r.workMode === 'Remote').length;
            let onLeave = todayRecords.filter(r => r.status === 'absent' && r.leaveType).length;
            let onBreak = todayRecords.filter(r => r.status === 'present' && r.timeIn && !r.timeOut && r.breakStart && !r.breakEnd).length;
            let pendingOut = todayRecords.filter(r => r.timeIn && !r.timeOut && !r.breakStart).length;
            let avgCheckin = '08:45';

            let html = `
                <div class="stat-card"><div class="stat-number">${present}</div><div class="stat-label">present today</div></div>
                <div class="stat-card"><div class="stat-number">${late}</div><div class="stat-label">late arrivals</div></div>
                <div class="stat-card"><div class="stat-number">${absent}</div><div class="stat-label">absent / leave</div></div>
                <div class="stat-card"><div class="stat-number">${remote}</div><div class="stat-label">remote workers</div></div>
                <div class="stat-card"><div class="stat-number">${onBreak}</div><div class="stat-label">on break</div></div>
                <div class="stat-card"><div class="stat-number">${pendingOut}</div><div class="stat-label">pending clock‚Äëout</div></div>
                <div class="stat-card"><div class="stat-number">${totalEmp}</div><div class="stat-label">total employees</div></div>
                <div class="stat-card"><div class="stat-number">${avgCheckin}</div><div class="stat-label">avg check‚Äëin</div></div>
            `;
            document.getElementById('statsGrid').innerHTML = html;
        }

        function renderLive() {
            let now = new Date();
            let today = now.toISOString().slice(0,10);
            let live = attendanceData.filter(r => r.date === today).slice(0,8);
            let html = live.map(r => {
                let emp = employees.find(e => e.id === r.employeeId) || {};
                let initials = (r.empName || '?').split(' ').map(n=>n[0]).join('');
                return `<div class="attendance-card">
                    <div class="employee-info"><div class="employee-avatar">${initials}</div><div><div style="font-weight:600;">${r.empName}</div><div style="font-size:0.875rem;">${r.dept}</div></div></div>
                    <div class="attendance-status status-${r.status}">${r.status}</div>
                    <div style="margin-top:0.5rem;">In: ${r.timeIn || '--'}<br>Out: ${r.timeOut || '--'}<br>mode: ${r.workMode || ''}<br>${r.locationName || ''} ${r.gps?'üìç':''}</div>
                </div>`;
            }).join('');
            document.getElementById('liveAttendanceGrid').innerHTML = html || '<p>no live data</p>';
        }

        function renderTable() {
            let recent = attendanceData.slice(0,8);
            let rows = recent.map(r => `<tr>
                <td>${r.empName}<br><small>${r.dept}</small></td>
                <td>${r.date}</td>
                <td><span class="time-in">${r.timeIn||'--'}</span> / <span class="time-out">${r.timeOut||'--'}</span></td>
                <td><span class="status-${r.status}" style="padding:0.25rem 0.5rem;border-radius:12px;">${r.status}</span></td>
                <td>${r.netWorked ? r.netWorked+'h' : '‚Äî'}</td>
                <td><button class="btn-primary" style="padding:0.25rem 0.75rem;" onclick="attendanceUI.editRecord('${r.id}')">‚úé edit</button></td>
            </tr>`).join('');
            document.getElementById('attendanceRecords').innerHTML = rows || '<tr><td colspan="6">no records</td></tr>';
        }

        window.attendanceUI.editRecord = function(id) {
            let rec = attendanceData.find(r => r.id === id);
            if (!rec) return;
            alert(`Edit record ${id}\nAll 137 fields available in full version.\nFor demo you can change status.`);
            // quick edit simulation
            let newStatus = prompt('Change status (present,late,absent,remote)', rec.status);
            if (newStatus) { rec.status = newStatus; persist(); renderTable(); renderLive(); renderStats(); }
        };

        function renderChart() {
            let days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            let html = days.map(d => `<div style="background:var(--success); width:30px; height:${Math.random()*200+50}px; border-radius:6px;" title="${d}"></div>`).join('');
            document.getElementById('attendanceChart').innerHTML = html;
        }

        // time updater
        function updateClock() {
            document.getElementById('currentTime').innerText = new Date().toLocaleString();
        }
        setInterval(updateClock, 1000);

        // initial render
        renderStats(); renderLive(); renderTable(); renderChart();
        updateClock();

        // service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(e=>console.log);
        }
    })();
</script>
</body>
</html>
