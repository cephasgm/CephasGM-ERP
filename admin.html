// pwa-init.js - Enhanced PWA Initialization for CephasGM ERP
class PWAInitializer {
  constructor() {
    this.isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    this.deferredPrompt = null;
    this.updateAvailable = false;
    this.registration = null;
    this.init();
  }

  async init() {
    await this.registerServiceWorker();
    this.setupInstallPrompt();
    this.setupOfflineDetection();
    this.setupAppBadge();
    this.setupPeriodicSync();
    this.setupPerformanceMonitoring();
    this.checkForUpdates();
    
    console.log('🚀 CephasGM ERP PWA Enhanced Initialization Complete');
    console.log('📱 Standalone Mode:', this.isStandalone);
    console.log('🔧 Service Worker:', 'serviceWorker' in navigator);
  }

  // Enhanced Service Worker Registration
  async registerServiceWorker() {
    if ('serviceWorker' in navigator) {
      try {
        this.registration = await navigator.serviceWorker.register('./sw.js', {
          scope: './',
          updateViaCache: 'none'
        });

        console.log('✅ Service Worker registered successfully:', this.registration);

        // Listen for updates
        this.registration.addEventListener('updatefound', () => {
          const newWorker = this.registration.installing;
          console.log('🔄 New Service Worker found...');
          
          newWorker.addEventListener('statechange', () => {
            console.log(`🔄 Service Worker state: ${newWorker.state}`);
            
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              this.updateAvailable = true;
              this.showUpdateNotification();
            }
          });
        });

        // Check if the page is controlled
        if (navigator.serviceWorker.controller) {
          console.log('🎯 This page is controlled by Service Worker');
        }

        // Set up periodic update checks
        setInterval(() => {
          this.registration.update();
        }, 60 * 60 * 1000); // Check every hour

      } catch (error) {
        console.error('❌ Service Worker registration failed:', error);
        this.showNotification('Service Worker registration failed. Some features may not work offline.', 'error');
      }
    } else {
      console.warn('⚠️ Service Workers are not supported');
    }
  }

  // Enhanced Install Prompt Handling
  setupInstallPrompt() {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      this.deferredPrompt = e;
      console.log('📱 Install prompt available');
      
      // Show install button after a delay
      setTimeout(() => {
        if (this.deferredPrompt && !this.isStandalone) {
          this.showInstallButton();
        }
      }, 3000);
    });

    window.addEventListener('appinstalled', (evt) => {
      console.log('🎉 PWA installed successfully');
      this.deferredPrompt = null;
      this.hideInstallButton();
      this.showNotification('App installed successfully! 🎉', 'success');
      
      // Track installation
      this.trackEvent('pwa_installed');
    });

    // Detect if already installed
    if (this.isStandalone) {
      console.log('📱 Running in standalone mode');
      this.trackEvent('pwa_standalone');
    }
  }

  // Enhanced Install Button
  showInstallButton() {
    // Remove existing button if any
    this.hideInstallButton();

    const installBtn = document.createElement('button');
    installBtn.id = 'pwa-install-btn';
    installBtn.innerHTML = `
      <span style="font-size: 1.2rem; margin-right: 0.5rem;">📱</span>
      Install CephasGM ERP
      <small style="display: block; font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
        Get full app experience
      </small>
    `;
    
    installBtn.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
      z-index: 10000;
      transition: all 0.3s ease;
      max-width: 200px;
      text-align: left;
      font-family: inherit;
    `;
    
    installBtn.addEventListener('mouseenter', () => {
      installBtn.style.transform = 'translateY(-2px) scale(1.02)';
      installBtn.style.boxShadow = '0 12px 30px rgba(37, 99, 235, 0.4)';
    });
    
    installBtn.addEventListener('mouseleave', () => {
      installBtn.style.transform = 'translateY(0) scale(1)';
      installBtn.style.boxShadow = '0 8px 25px rgba(37, 99, 235, 0.3)';
    });

    installBtn.addEventListener('click', () => this.installApp());
    document.body.appendChild(installBtn);

    // Auto-hide after 30 seconds
    setTimeout(() => {
      this.hideInstallButton();
    }, 30000);
  }

  hideInstallButton() {
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
      installBtn.remove();
    }
  }

  // Enhanced App Installation
  async installApp() {
    if (this.deferredPrompt) {
      try {
        this.deferredPrompt.prompt();
        const { outcome } = await this.deferredPrompt.userChoice;
        
        console.log(`📱 User ${outcome} the install prompt`);
        
        if (outcome === 'accepted') {
          this.trackEvent('pwa_install_accepted');
        } else {
          this.trackEvent('pwa_install_declined');
        }
        
        this.deferredPrompt = null;
        this.hideInstallButton();
      } catch (error) {
        console.error('❌ Install prompt error:', error);
        this.showNotification('Failed to install app. Please try again.', 'error');
      }
    } else {
      this.showNotification('App installation not available', 'info');
    }
  }

  // Enhanced Offline Detection
  setupOfflineDetection() {
    window.addEventListener('online', () => {
      this.showNotification('Connection restored ✅', 'success');
      document.body.classList.remove('offline');
      this.trackEvent('connection_restored');
      
      // Sync data when coming back online
      this.syncOfflineData();
    });

    window.addEventListener('offline', () => {
      this.showNotification('You are currently offline 📶', 'warning');
      document.body.classList.add('offline');
      this.trackEvent('connection_lost');
    });

    // Initial check
    if (!navigator.onLine) {
      document.body.classList.add('offline');
      this.showNotification('You are currently offline 📶', 'warning');
    }

    // Add offline indicator to page
    this.addOfflineIndicator();
  }

  addOfflineIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'offline-indicator';
    indicator.innerHTML = '📶 Offline';
    indicator.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f59e0b;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 10001;
      display: none;
    `;
    document.body.appendChild(indicator);

    // Update visibility based on connection status
    const updateIndicator = () => {
      indicator.style.display = navigator.onLine ? 'none' : 'block';
    };

    window.addEventListener('online', updateIndicator);
    window.addEventListener('offline', updateIndicator);
    updateIndicator();
  }

  // Enhanced App Badge
  setupAppBadge() {
    if ('setAppBadge' in navigator) {
      // Set initial badge (could be based on notifications)
      // navigator.setAppBadge(0);
      
      // Listen for notification changes
      // this.setupBadgeUpdates();
    }
  }

  // Periodic Background Sync
  setupPeriodicSync() {
    if ('periodicSync' in navigator && this.registration) {
      try {
        navigator.periodicSync.register('content-update', {
          minInterval: 24 * 60 * 60 * 1000 // 24 hours
        }).then(() => {
          console.log('🔄 Periodic sync registered');
        });
      } catch (error) {
        console.log('⚠️ Periodic sync not supported:', error);
      }
    }
  }

  // Performance Monitoring
  setupPerformanceMonitoring() {
    // Monitor Core Web Vitals
    if ('PerformanceObserver' in window) {
      try {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            console.log(`📊 ${entry.name}:`, entry.value);
            
            // Track important metrics
            if (entry.name === 'first-contentful-paint') {
              this.trackEvent('performance_fcp', Math.round(entry.value));
            }
            if (entry.name === 'largest-contentful-paint') {
              this.trackEvent('performance_lcp', Math.round(entry.value));
            }
          }
        });

        observer.observe({ entryTypes: ['paint', 'largest-contentful-paint'] });
      } catch (error) {
        console.log('⚠️ Performance monitoring not available:', error);
      }
    }
  }

  // Enhanced Update Notifications
  showUpdateNotification() {
    if (this.isStandalone) {
      this.showNotification('New version available! Restart the app to update. 🔄', 'info', {
        actions: [
          {
            label: 'Update Now',
            callback: () => this.updateApp()
          }
        ]
      });
    } else {
      this.showUpdateButton();
    }
  }

  showUpdateButton() {
    const updateBtn = document.createElement('button');
    updateBtn.id = 'pwa-update-btn';
    updateBtn.innerHTML = '🔄 Update Available';
    updateBtn.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #f59e0b;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      transition: all 0.3s ease;
    `;
    
    updateBtn.addEventListener('click', () => this.updateApp());
    document.body.appendChild(updateBtn);

    // Auto-hide after 1 minute
    setTimeout(() => {
      updateBtn.remove();
    }, 60000);
  }

  updateApp() {
    if (this.registration && this.registration.waiting) {
      this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      
      // Reload page when user navigates
      const reloadPage = () => {
        window.location.reload();
      };
      
      this.showNotification('Updating app...', 'info');
      setTimeout(reloadPage, 1000);
    }
  }

  // Enhanced Check for Updates
  checkForUpdates() {
    if (this.registration) {
      this.registration.update().then(() => {
        console.log('🔄 Update check completed');
      });
    }

    // Check every 6 hours
    setInterval(() => {
      if (this.registration) {
        this.registration.update();
      }
    }, 6 * 60 * 60 * 1000);
  }

  // Enhanced Notification System
  showNotification(message, type = 'info', options = {}) {
    // Use native notifications if available and permitted
    if ('Notification' in window && Notification.permission === 'granted') {
      const notification = new Notification('CephasGM ERP', {
        body: message,
        icon: './icon-192.png',
        badge: './icon-192.png',
        tag: 'erp-notification'
      });

      notification.onclick = () => {
        window.focus();
        notification.close();
      };

      return;
    }

    // Fallback to in-app notifications
    this.showInAppNotification(message, type, options);
  }

  showInAppNotification(message, type, options = {}) {
    // Remove existing notification
    this.hideInAppNotification();

    const notification = document.createElement('div');
    notification.id = 'in-app-notification';
    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 0.75rem;">
        <span style="font-size: 1.25rem;">${this.getNotificationIcon(type)}</span>
        <div>
          <div style="font-weight: 600;">${message}</div>
          ${options.actions ? `
            <div style="margin-top: 0.5rem;">
              ${options.actions.map(action => 
                `<button onclick="${action.callback}" style="background: var(--primary); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; margin-right: 0.5rem; cursor: pointer; font-size: 0.75rem;">
                  ${action.label}
                </button>`
              ).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    `;

    const backgroundColor = {
      info: '#3b82f6',
      success: '#10b981',
      warning: '#f59e0b',
      error: '#ef4444'
    }[type] || '#3b82f6';

    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${backgroundColor};
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      z-index: 10002;
      max-width: 400px;
      animation: slideInRight 0.3s ease;
    `;

    document.body.appendChild(notification);

    // Auto-hide after 5 seconds
    setTimeout(() => {
      this.hideInAppNotification();
    }, 5000);
  }

  hideInAppNotification() {
    const notification = document.getElementById('in-app-notification');
    if (notification) {
      notification.remove();
    }
  }

  getNotificationIcon(type) {
    const icons = {
      info: 'ℹ️',
      success: '✅',
      warning: '⚠️',
      error: '❌'
    };
    return icons[type] || 'ℹ️';
  }

  // Enhanced Data Sync for Offline Usage
  async syncOfflineData() {
    console.log('🔄 Syncing offline data...');
    
    // Implementation for syncing any pending offline data
    // This would sync form submissions, updates, etc.
    
    try {
      // Example: Sync pending forms
      const pendingForms = JSON.parse(localStorage.getItem('pendingForms') || '[]');
      
      for (const form of pendingForms) {
        // Send form data to server
        const response = await fetch(form.url, {
          method: 'POST',
          body: JSON.stringify(form.data),
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          // Remove from pending forms
          pendingForms.splice(pendingForms.indexOf(form), 1);
        }
      }
      
      localStorage.setItem('pendingForms', JSON.stringify(pendingForms));
      console.log('✅ Offline data sync completed');
    } catch (error) {
      console.error('❌ Offline data sync failed:', error);
    }
  }

  // Enhanced Analytics and Tracking
  trackEvent(eventName, value = null) {
    const eventData = {
      event: eventName,
      timestamp: new Date().toISOString(),
      url: window.location.href,
      userAgent: navigator.userAgent,
      standalone: this.isStandalone,
      value: value
    };

    console.log('📊 Event tracked:', eventData);
    
    // Store events for later submission
    const events = JSON.parse(localStorage.getItem('pwa_events') || '[]');
    events.push(eventData);
    localStorage.setItem('pwa_events', JSON.stringify(events.slice(-100))); // Keep last 100 events
    
    // Try to send immediately if online
    if (navigator.onLine) {
      this.sendEventsToAnalytics();
    }
  }

  async sendEventsToAnalytics() {
    const events = JSON.parse(localStorage.getItem('pwa_events') || '[]');
    
    if (events.length > 0) {
      try {
        // In a real implementation, send to your analytics service
        console.log('📊 Sending analytics events:', events.length);
        
        // Clear sent events
        localStorage.setItem('pwa_events', '[]');
      } catch (error) {
        console.error('❌ Analytics send failed:', error);
      }
    }
  }

  // Enhanced Cache Management
  async getCacheInfo() {
    if ('serviceWorker' in navigator && this.registration) {
      try {
        const cache = await caches.open('cephasgm-erp-v4.0');
        const keys = await cache.keys();
        
        return {
          cacheName: 'cephasgm-erp-v4.0',
          cachedItems: keys.length,
          totalSize: 'N/A' // Would need more complex calculation
        };
      } catch (error) {
        console.error('❌ Cache info error:', error);
        return null;
      }
    }
    return null;
  }

  // Enhanced Error Handling
  setupErrorHandling() {
    window.addEventListener('error', (event) => {
      this.trackEvent('javascript_error', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno
      });
    });

    window.addEventListener('unhandledrejection', (event) => {
      this.trackEvent('promise_rejection', {
        reason: event.reason?.toString()
      });
    });
  }
}

// Initialize PWA when DOM is loaded
document.addEventListener('DOMContentLoaded', async () => {
  // Add PWA meta tags
  addPWAMetaTags();
  
  // Request notification permission
  if ('Notification' in window && Notification.permission === 'default') {
    try {
      await Notification.requestPermission();
    } catch (error) {
      console.log('Notification permission request failed:', error);
    }
  }
  
  // Initialize PWA
  window.pwa = new PWAInitializer();
  
  // Add CSS for animations
  addNotificationCSS();
});

// Add necessary meta tags
function addPWAMetaTags() {
  const metaTags = [
    { name: 'theme-color', content: '#2563eb' },
    { name: 'apple-mobile-web-app-capable', content: 'yes' },
    { name: 'apple-mobile-web-app-status-bar-style', content: 'black-translucent' },
    { name: 'apple-mobile-web-app-title', content: 'CephasGM ERP' },
    { name: 'mobile-web-app-capable', content: 'yes' },
    { name: 'msapplication-TileColor', content: '#2563eb' },
    { name: 'msapplication-config', content: '/browserconfig.xml' }
  ];

  metaTags.forEach(tag => {
    const existing = document.querySelector(`meta[name="${tag.name}"]`);
    if (!existing) {
      const meta = document.createElement('meta');
      meta.name = tag.name;
      meta.content = tag.content;
      document.head.appendChild(meta);
    }
  });

  // Add Apple touch icon
  const appleIcon = document.createElement('link');
  appleIcon.rel = 'apple-touch-icon';
  appleIcon.href = './icon-192.png';
  document.head.appendChild(appleIcon);
}

// Add CSS for notifications
function addNotificationCSS() {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .offline {
      filter: grayscale(0.3);
    }
    
    .offline::before {
      content: '📶 Offline';
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f59e0b;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 10001;
    }
  `;
  document.head.appendChild(style);
}

// Export for module usage
if (typeof module !== 'undefined' && module.exports) {
  module.exports = PWAInitializer;
}
